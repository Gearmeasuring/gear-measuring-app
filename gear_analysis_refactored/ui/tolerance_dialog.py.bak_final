import sys
import os
from PyQt5.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QTreeWidget, QTreeWidgetItem, 
                             QStackedWidget, QWidget, QLabel, QLineEdit, QPushButton, 
                             QCheckBox, QGroupBox, QGridLayout, QComboBox, QScrollArea,
                             QFrame, QSpinBox, QMessageBox, QHeaderView, QToolButton)
from PyQt5.QtCore import Qt, pyqtSignal, QSize
from PyQt5.QtGui import QFont, QColor, QBrush, QIcon, QPixmap

class ToleranceSettingsDialog(QDialog):
    """Tolerance Settings Dialog matching the provided design"""
    
    tolerances_updated = pyqtSignal(dict)
    
    def __init__(self, gear_data=None, parent=None):
        super().__init__(parent)
        self.gear_data = gear_data or {}
        self.current_page_id = None  # Track current page ID
        self.quality_spins = {}  # Dictionary to store quality spin boxes
        self.setWindowTitle("Tolerance Settings")
        self.resize(1000, 700)
        
        self.init_ui()
        self.load_initial_data()
        
    def init_ui(self):
        main_layout = QHBoxLayout(self)
        
        # Left Side: Tree View
        self.tree_widget = QTreeWidget()
        self.tree_widget.setHeaderLabel("Tolerance")
        self.tree_widget.setFixedWidth(250)
        self.tree_widget.itemClicked.connect(self.on_tree_item_clicked)
        main_layout.addWidget(self.tree_widget)
        
        # Populate Tree
        self.populate_tree()
        
        # Right Side: Content Area
        self.content_stack = QStackedWidget()
        main_layout.addWidget(self.content_stack)
        
        
        # Create Pages
        # Order matches the page_mapping in on_tree_item_clicked
        self.create_din3962_profile_page()
        self.create_din3962_lead_page()
        self.create_din3962_spacing_page()
        self.create_agma_profile_page()
        self.create_agma_lead_page()
        self.create_agma_spacing_page()
        self.create_iso1328_1997_profile_page()
        self.create_iso1328_1997_lead_page()
        self.create_iso1328_1997_spacing_page()
        self.create_iso1328_2013_profile_page()
        self.create_iso1328_2013_lead_page()
        self.create_iso1328_2013_spacing_page()
        self.create_ansi_b921_profile_page()
        self.create_ansi_b921_lead_page()
        self.create_ansi_b921_spacing_page()
        self.create_din5480_profile_page()
        self.create_din5480_lead_page()
        self.create_din5480_spacing_page()
        self.create_empty_page() # Empty page for extra items under DIN 5480
        self.content_stack.setCurrentIndex(0)
        
    def populate_tree(self):
        self.tree_widget.clear()
        
        # Root: Tolerance
        root_tolerance = QTreeWidgetItem(self.tree_widget)
        root_tolerance.setText(0, "Tolerance")
        root_tolerance.setExpanded(True)
        
        standards = [
            ("DIN 3962", ["Profile", "Lead / Line of action", "Spacing"]),
            ("AGMA", ["Profile", "Lead / Line of action", "Spacing"]),
            ("ISO 1328 : 1997", ["Profile", "Lead / Line of action", "Spacing"]),
            ("ISO 1328 : 2013", ["Profile", "Lead / Line of action", "Spacing"]),
            ("ANSI B92.1", ["Profile", "Lead / Line of action", "Spacing"]),
            ("DIN 5480", ["Profile", "Lead / Line of action", "Spacing", "Tolerance fields", "Measurement over balls", "Root diameter / Tip diameter"])
        ]
        
        for std_name, sub_items in standards:
            item = QTreeWidgetItem(root_tolerance)
            item.setText(0, std_name)
            item.setExpanded(False)
            
            if std_name == "ISO 1328 : 2013":
                item.setExpanded(True)
            
            for sub in sub_items:
                sub_item = QTreeWidgetItem(item)
                sub_item.setText(0, sub)
                
                # Highlight "Profile" under "DIN 3962" with blue background
                if std_name == "DIN 3962" and sub == "Profile":
                    sub_item.setBackground(0, QBrush(QColor(100, 150, 255)))  # Light blue background
                    sub_item.setForeground(0, QBrush(QColor(255, 255, 255)))  # White text for contrast
                
                # Store page index reference
                # We will map these to specific pages
                page_id = f"{std_name}_{sub}"
                sub_item.setData(0, Qt.UserRole, page_id)

        # Other Roots
        for root_name in ["Output", "Evaluation", "Options"]:
            item = QTreeWidgetItem(self.tree_widget)
            item.setText(0, root_name)
            item.setData(0, Qt.UserRole, f"ROOT_{root_name}")
                    
    def on_tree_item_clicked(self, item, column):
        page_id = item.data(0, Qt.UserRole)
        if page_id is None:
            return
        self.current_page_id = page_id  # Track current page
        
        self.current_page_id = page_id  # Track current page
            
        # Map IDs to stack indices
        page_mapping = {
            "DIN 3962_Profile": 0,
            "DIN 3962_Lead / Line of action": 1,
            "DIN 3962_Spacing": 2,
            "AGMA_Profile": 3,
            "AGMA_Lead / Line of action": 4,
            "AGMA_Spacing": 5,
            "ISO 1328 : 1997_Profile": 6,
            "ISO 1328 : 1997_Lead / Line of action": 7,
            "ISO 1328 : 1997_Spacing": 8,
            "ISO 1328 : 2013_Profile": 9,
            "ISO 1328 : 2013_Lead / Line of action": 10,
            "ISO 1328 : 2013_Spacing": 11,
            "ANSI B92.1_Profile": 12,
            "ANSI B92.1_Lead / Line of action": 13,
            "ANSI B92.1_Spacing": 14,
            "DIN 5480_Profile": 15,
            "DIN 5480_Lead / Line of action": 16,
            "DIN 5480_Spacing": 17,
            "default": 18
        }
        # Get page index from mapping
        if page_id in page_mapping:
            index = page_mapping[page_id]
            self.content_stack.setCurrentIndex(index)
            
            # Set window title based on page_id
            if "Profile" in page_id:
                standard = page_id.split("_", 1)[0]
                self.setWindowTitle(f"Tolerances acc.to {standard} Profile")
            elif "Lead" in page_id:
                standard = page_id.split("_", 1)[0]
                self.setWindowTitle(f"Tolerances acc.to {standard} Lead")
            elif "Spacing" in page_id:
                standard = page_id.split("_", 1)[0]
                self.setWindowTitle(f"Tolerances acc.to {standard} Spacing")
            else:
                self.setWindowTitle("Tolerance Settings")
        else:
            self.content_stack.setCurrentIndex(18)  # Empty page
            self.setWindowTitle("Tolerance Settings")
            
    def create_iso1328_2013_profile_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        # Using a gray color to match the MDI style
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800) # Set a reasonable fixed width or let it expand
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon (Blue diamond/logo placeholder)
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN Profile"))
        title_layout.addStretch()
        
        # Window Controls
        # Minimize/Maximize buttons (Visual only)
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.profile_quality_spin = QSpinBox()
        self.quality_spins["ISO 1328 : 2013_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 5480_Profile"] = self.profile_quality_spin
        self.quality_spins["ANSI B92.1_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 2013_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 1997_Profile"] = self.profile_quality_spin
        self.quality_spins["AGMA_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 3962_Profile"] = self.profile_quality_spin
        self.profile_quality_spin.setRange(1, 12)
        self.profile_quality_spin.setValue(5)
        self.profile_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.profile_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("profile"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Tooth Profile Icon
        icon_label = QLabel()
        # Use relative path for portability
        current_dir = os.path.dirname(os.path.abspath(__file__))
        icon_path = os.path.join(current_dir, "resources", "profile_tolerance_icon.png")
        
        try:
            from PyQt5.QtGui import QPixmap
            pixmap = QPixmap(icon_path)
            if not pixmap.isNull():
                # Increased size to 100x100 as requested
                icon_label.setPixmap(pixmap.scaled(100, 100, Qt.KeepAspectRatio, Qt.SmoothTransformation))
            else:
                # Fallback if image not found
                icon_label.setText("Profile")
                icon_label.setAlignment(Qt.AlignCenter)
                icon_label.setFixedSize(100, 100)
        except Exception as e:
            print(f"Error loading icon: {e}")
            icon_label.setText("Icon")
            icon_label.setFixedSize(100, 100)
            
        icon_label.setStyleSheet("background-color: white; border: 1px solid #ccc; padding: 5px;")
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        layout.addSpacing(10)
        
        # Main Table Frame
        table_frame = QFrame()
        table_frame.setFrameShape(QFrame.Box)
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        # Nom. val is a Label
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.btn_lim_upp_l = QPushButton("Lim. upp.")
        self.btn_lim_low_l = QPushButton("Lim. low.")
        self.btn_qual_l = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_l, self.btn_lim_low_l, self.btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_l.setChecked(True)
        self.btn_lim_low_l.setChecked(True)
        self.btn_qual_l.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_lim_low_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_qual_l.clicked.connect(lambda: self.toggle_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.btn_qual_l, 1, 6)
        
        # Right Side Headers
        # Nom. val is a Label
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.btn_lim_upp_r = QPushButton("Lim. upp.")
        self.btn_lim_low_r = QPushButton("Lim. low.")
        self.btn_qual_r = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_r, self.btn_lim_low_r, self.btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_r.setChecked(True)
        self.btn_lim_low_r.setChecked(True)
        self.btn_qual_r.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_lim_low_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_qual_r.clicked.connect(lambda: self.toggle_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.btn_qual_r, 1, 11)
        
        # Data Rows
        self.profile_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_Editable: True=QLineEdit, False=QLabel)
        # True = Visible, False = Hidden
        rows = [
            ("Angular error", "fHa", True, 
             [True, True, True, True], [True, True, True, True], False), # All visible, Nom not editable
            ("Variance Ang.err.", "Var", True, 
             [False, True, False, False], [False, True, False, False], False), # Nom, Low, Qual hidden
            ("Total error", "Fa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Form error", "ffa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Crowning", "Ca", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Tip-relief", "fKo", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Root-relief", "fFu", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Profile twist", "PV", True, 
             [True, True, True, False], [True, True, True, False], True)  # Qual hidden, Nom EDITABLE
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_editable) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.profile_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_l = QLineEdit("0.0")
                nom_l.setAlignment(Qt.AlignRight)
            else:
                nom_l = QLabel("0.0")
                nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_l = QLineEdit("0.0")
            low_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            low_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            
            if left_vis[0]: grid_layout.addWidget(nom_l, r, 3)
            else: nom_l.setVisible(False)
            
            if left_vis[1]: grid_layout.addWidget(upp_l, r, 4)
            else: upp_l.setVisible(False)
            
            if left_vis[2]: grid_layout.addWidget(low_l, r, 5)
            else: low_l.setVisible(False)
            
            if left_vis[3]: grid_layout.addWidget(qual_l, r, 6)
            else: qual_l.setVisible(False)
            
            # Right Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_r = QLineEdit("0.0")
                nom_r.setAlignment(Qt.AlignRight)
            else:
                nom_r = QLabel("0.0")
                nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_r = QLineEdit("0.0")
            low_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_r.setAlignment(Qt.AlignRight)
            low_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            if right_vis[0]: grid_layout.addWidget(nom_r, r, 8)
            else: nom_r.setVisible(False)
            
            if right_vis[1]: grid_layout.addWidget(upp_r, r, 9)
            else: upp_r.setVisible(False)
            
            if right_vis[2]: grid_layout.addWidget(low_r, r, 10)
            else: low_r.setVisible(False)
            
            if right_vis[3]: grid_layout.addWidget(qual_r, r, 11)
            else: qual_r.setVisible(False)
            
            # Store references
            self.profile_inputs[code] = {
                "left": {"nom": nom_l, "upp": upp_l, "low": low_l, "qual": qual_l},
                "right": {"nom": nom_r, "upp": upp_r, "low": low_r, "qual": qual_r}
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right) - under left section
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "profile"))
        
        # Left Copy Button (Right to Left) - under right section
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "profile"))
        
        # Add buttons to grid
        # Centered under the respective sections
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Under Left section? No, usually arrows point direction.
        # Ref image shows arrows at bottom.
        # Left arrow is under Right section pointing Left? Or under Left section?
        # Image 1 shows:
        # Left side has "Ba ->" (Left to Right?) No, wait.
        # Image 1 shows:
        # Under Left section: Arrow pointing RIGHT (Ba ->)
        # Under Right section: Arrow pointing LEFT (<- Ba)
        # Wait, usually "Ba ->" means Copy FROM Ba TO other?
        # Let's assume:
        # Button under Left section: Copy Left -> Right
        # Button under Right section: Copy Right -> Left
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Left side, arrow pointing right
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter) # Right side, arrow pointing left
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)

    def create_iso1328_2013_lead_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN 3962 Lead"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.lead_quality_spin = QSpinBox()
        self.lead_quality_spin.setRange(1, 12)
        self.lead_quality_spin.setValue(5)
        self.lead_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.lead_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }""")
        set_btn.clicked.connect(lambda: self.calculate_tolerances("lead"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Add Lead Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "lead_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            # Scale to reasonable height if needed, e.g. 60px
            if pixmap.height() > 60:
                pixmap = pixmap.scaledToHeight(60, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Table Frame
        table_frame = QFrame()
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.lead_btn_lim_upp_l = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_l = QPushButton("Lim. low.")
        self.lead_btn_qual_l = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_l, self.lead_btn_lim_low_l, self.lead_btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_l.setChecked(True)
        self.lead_btn_lim_low_l.setChecked(True)
        self.lead_btn_qual_l.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_lim_low_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_qual_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.lead_btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.lead_btn_qual_l, 1, 6)
        
        # Right Side Headers
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.lead_btn_lim_upp_r = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_r = QPushButton("Lim. low.")
        self.lead_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_r, self.lead_btn_lim_low_r, self.lead_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_r.setChecked(True)
        self.lead_btn_lim_low_r.setChecked(True)
        self.lead_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_lim_low_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_qual_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.lead_btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.lead_btn_qual_r, 1, 11)
        
        # Data Rows
        self.lead_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_is_label: True=QLabel (no border), False=QLineEdit)
        rows = [
            ("Angular error", "fHb", True, [True, True, True, True], [True, True, True, True], True),
            ("Variance Ang.err.", "Var", True, [False, True, False, False], [False, True, False, False], False),
            ("Total error", "Fb", True, [False, True, False, True], [False, True, False, True], False),
            ("Form error", "ffb", True, [False, True, False, True], [False, True, False, True], False),
            ("Crowning", "Cb", True, [True, True, True, False], [True, True, True, False], True),
            ("Top-relief (lead)", "fo", True, [True, True, True, False], [True, True, True, False], True),
            ("Bottom-relief (lead)", "fu", True, [True, True, True, False], [True, True, True, False], True),
            ("Bending", "FV", True, [True, True, True, False], [True, True, True, False], False)
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_is_label) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.lead_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            left_widgets = {}
            
            if left_vis[0]: # Nom
                if nom_is_label:
                    nom_l = QLabel("0.0")
                    nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_l = QLineEdit("0.0")
                    nom_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_l, r, 3)
                left_widgets["nom"] = nom_l
            
            if left_vis[1]: # Upp
                upp_l = QLineEdit("0.0")
                upp_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_l, r, 4)
                left_widgets["upp"] = upp_l
                
            if left_vis[2]: # Low
                low_l = QLineEdit("0.0")
                low_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_l, r, 5)
                left_widgets["low"] = low_l
                
            if left_vis[3]: # Qual
                qual_l = QLineEdit("5")
                qual_l.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_l, r, 6)
                left_widgets["qual"] = qual_l
            
            # Right Side inputs
            right_widgets = {}
            
            if right_vis[0]: # Nom
                if nom_is_label:
                    nom_r = QLabel("0.0")
                    nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_r = QLineEdit("0.0")
                    nom_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_r, r, 8)
                right_widgets["nom"] = nom_r
                
            if right_vis[1]: # Upp
                upp_r = QLineEdit("0.0")
                upp_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_r, r, 9)
                right_widgets["upp"] = upp_r
                
            if right_vis[2]: # Low
                low_r = QLineEdit("0.0")
                low_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_r, r, 10)
                right_widgets["low"] = low_r
                
            if right_vis[3]: # Qual
                qual_r = QLineEdit("5")
                qual_r.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_r, r, 11)
                right_widgets["qual"] = qual_r
            
            # Store references
            self.lead_inputs[code] = {
                "left": left_widgets,
                "right": right_widgets
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right)
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "lead"))
        
        # Left Copy Button (Right to Left)
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "lead"))
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter)
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter)
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize field states
        self.toggle_lead_header_mode("left", "limits")
        self.toggle_lead_header_mode("right", "limits")

    def create_iso1328_2013_spacing_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN Spacing"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
            QGroupBox {
                border: 1px solid #808080;
                margin-top: 10px;
                font-weight: normal;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 3px;
                left: 10px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.spacing_quality_spin = QSpinBox()
        self.spacing_quality_spin.setRange(1, 12)
        self.spacing_quality_spin.setValue(5)
        self.spacing_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.spacing_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("spacing"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Spacing Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "spacing_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            if pixmap.height() > 80:
                pixmap = pixmap.scaledToHeight(80, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        else:
            # Placeholder if no icon
            icon_label.setText("Spacing")
            icon_label.setStyleSheet("border: 1px solid #ccc; background: white; padding: 5px;")
            icon_label.setFixedSize(80, 80)
            icon_label.setAlignment(Qt.AlignCenter)
            
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Spacing Group
        spacing_group = QGroupBox("Spacing")
        spacing_layout = QGridLayout(spacing_group)
        spacing_layout.setSpacing(5)
        spacing_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        spacing_layout.addWidget(QLabel("left"), 0, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(QLabel("right"), 0, 5, 1, 2, Qt.AlignCenter)
        
        # Add vertical separator
        sep = QFrame()
        sep.setFrameShape(QFrame.VLine)
        sep.setFrameShadow(QFrame.Sunken)
        sep.setStyleSheet("color: #808080;")
        spacing_layout.addWidget(sep, 0, 4, 7, 1) # Span down to cover rows
        
        # Buttons/Headers
        self.spacing_btn_lim_l = QPushButton("Lim. upp.")
        self.spacing_btn_qual_l = QPushButton("Quality")
        self.spacing_btn_lim_r = QPushButton("Lim. upp.")
        self.spacing_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.spacing_btn_lim_l, self.spacing_btn_qual_l, self.spacing_btn_lim_r, self.spacing_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.spacing_btn_lim_l.setChecked(True)
        self.spacing_btn_qual_l.setChecked(False)
        self.spacing_btn_lim_r.setChecked(True)
        self.spacing_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.spacing_btn_lim_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "limits"))
        self.spacing_btn_qual_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "quality"))
        self.spacing_btn_lim_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "limits"))
        self.spacing_btn_qual_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "quality"))
        
        spacing_layout.addWidget(self.spacing_btn_lim_l, 1, 2)
        spacing_layout.addWidget(self.spacing_btn_qual_l, 1, 3)
        spacing_layout.addWidget(self.spacing_btn_lim_r, 1, 5)
        spacing_layout.addWidget(self.spacing_btn_qual_r, 1, 6)
        
        self.spacing_inputs = {}
        rows = [
            ("Individual error", "fp"),
            ("Pitch jump", "fu"),
            ("Total error", "Fp"),
            ("Pitch-span var.", "Fpz/8")
        ]
        
        for r, (label, code) in enumerate(rows):
            row_idx = r + 2
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            spacing_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            upp_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            upp_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            spacing_layout.addWidget(upp_l, row_idx, 2)
            spacing_layout.addWidget(qual_l, row_idx, 3)
            spacing_layout.addWidget(upp_r, row_idx, 5)
            spacing_layout.addWidget(qual_r, row_idx, 6)
            
            self.spacing_inputs[code] = {
                "left": {"upp": upp_l, "qual": qual_l},
                "right": {"upp": upp_r, "qual": qual_r}
            }
            
        # Copy Buttons
        copy_row = len(rows) + 2
        
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover { background-color: #e0e0ff; }
            QPushButton:pressed { border: 2px inset #a0a0a0; background-color: #d0d0d0; }
        """
        
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(60, 30)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "spacing"))
        
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(60, 30)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "spacing"))
        
        spacing_layout.addWidget(copy_r_btn, copy_row, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(copy_l_btn, copy_row, 5, 1, 2, Qt.AlignCenter)
            
        layout.addWidget(spacing_group)
        
        # Run-out Group
        runout_group = QGroupBox("Run-out / Tooth thickness")
        runout_layout = QGridLayout(runout_group)
        runout_layout.setSpacing(5)
        runout_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        self.runout_btn_lim = QPushButton("Lim. upp.")
        self.runout_btn_qual = QPushButton("Quality")
        
        for btn in [self.runout_btn_lim, self.runout_btn_qual]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.runout_btn_lim.setChecked(True)
        self.runout_btn_qual.setChecked(False)
        
        # Connect signals
        self.runout_btn_lim.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "limits"))
        self.runout_btn_qual.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "quality"))
        
        runout_layout.addWidget(self.runout_btn_lim, 0, 2)
        runout_layout.addWidget(self.runout_btn_qual, 0, 3)
        
        rows_runout = [
            ("Run-out", "Fr"),
            ("Variation of tooth thickness", "Rs")
        ]
        
        for r, (label, code) in enumerate(rows_runout):
            row_idx = r + 1
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            runout_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp = QLineEdit("0.0")
            qual = QLineEdit("5")
            
            upp.setAlignment(Qt.AlignRight)
            qual.setAlignment(Qt.AlignCenter)
            
            runout_layout.addWidget(upp, row_idx, 2)
            runout_layout.addWidget(qual, row_idx, 3)
            
            self.spacing_inputs[code] = {"upp": upp, "qual": qual}
            
        layout.addWidget(runout_group)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
            
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize
        self.toggle_spacing_header_mode("left", "limits")
        self.toggle_spacing_header_mode("right", "limits")
        self.toggle_spacing_header_mode("runout", "limits")

    def create_din3962_profile_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        # Using a gray color to match the MDI style
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800) # Set a reasonable fixed width or let it expand
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon (Blue diamond/logo placeholder)
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN 3962 Profile"))
        title_layout.addStretch()
        
        # Window Controls
        # Minimize/Maximize buttons (Visual only)
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.profile_quality_spin = QSpinBox()
        self.quality_spins["DIN 3962_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 5480_Profile"] = self.profile_quality_spin
        self.quality_spins["ANSI B92.1_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 2013_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 1997_Profile"] = self.profile_quality_spin
        self.quality_spins["AGMA_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 3962_Profile"] = self.profile_quality_spin
        self.profile_quality_spin.setRange(1, 12)
        self.profile_quality_spin.setValue(5)
        self.profile_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.profile_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("profile"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Tooth Profile Icon
        icon_label = QLabel()
        # Use relative path for portability
        current_dir = os.path.dirname(os.path.abspath(__file__))
        icon_path = os.path.join(current_dir, "resources", "profile_tolerance_icon.png")
        
        try:
            from PyQt5.QtGui import QPixmap
            pixmap = QPixmap(icon_path)
            if not pixmap.isNull():
                # Increased size to 100x100 as requested
                icon_label.setPixmap(pixmap.scaled(100, 100, Qt.KeepAspectRatio, Qt.SmoothTransformation))
            else:
                # Fallback if image not found
                icon_label.setText("Profile")
                icon_label.setAlignment(Qt.AlignCenter)
                icon_label.setFixedSize(100, 100)
        except Exception as e:
            print(f"Error loading icon: {e}")
            icon_label.setText("Icon")
            icon_label.setFixedSize(100, 100)
            
        icon_label.setStyleSheet("background-color: white; border: 1px solid #ccc; padding: 5px;")
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        layout.addSpacing(10)
        
        # Main Table Frame
        table_frame = QFrame()
        table_frame.setFrameShape(QFrame.Box)
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        # Nom. val is a Label
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.btn_lim_upp_l = QPushButton("Lim. upp.")
        self.btn_lim_low_l = QPushButton("Lim. low.")
        self.btn_qual_l = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_l, self.btn_lim_low_l, self.btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_l.setChecked(True)
        self.btn_lim_low_l.setChecked(True)
        self.btn_qual_l.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_lim_low_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_qual_l.clicked.connect(lambda: self.toggle_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.btn_qual_l, 1, 6)
        
        # Right Side Headers
        # Nom. val is a Label
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.btn_lim_upp_r = QPushButton("Lim. upp.")
        self.btn_lim_low_r = QPushButton("Lim. low.")
        self.btn_qual_r = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_r, self.btn_lim_low_r, self.btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_r.setChecked(True)
        self.btn_lim_low_r.setChecked(True)
        self.btn_qual_r.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_lim_low_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_qual_r.clicked.connect(lambda: self.toggle_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.btn_qual_r, 1, 11)
        
        # Data Rows
        self.profile_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_Editable: True=QLineEdit, False=QLabel)
        # True = Visible, False = Hidden
        rows = [
            ("Angular error", "fHa", True, 
             [True, True, True, True], [True, True, True, True], False), # All visible, Nom not editable
            ("Variance Ang.err.", "Var", True, 
             [False, True, False, False], [False, True, False, False], False), # Nom, Low, Qual hidden
            ("Total error", "Fa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Form error", "ffa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Crowning", "Ca", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Tip-relief", "fKo", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Root-relief", "fFu", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Profile twist", "PV", True, 
             [True, True, True, False], [True, True, True, False], True)  # Qual hidden, Nom EDITABLE
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_editable) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.profile_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_l = QLineEdit("0.0")
                nom_l.setAlignment(Qt.AlignRight)
            else:
                nom_l = QLabel("0.0")
                nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_l = QLineEdit("0.0")
            low_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            low_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            
            if left_vis[0]: grid_layout.addWidget(nom_l, r, 3)
            else: nom_l.setVisible(False)
            
            if left_vis[1]: grid_layout.addWidget(upp_l, r, 4)
            else: upp_l.setVisible(False)
            
            if left_vis[2]: grid_layout.addWidget(low_l, r, 5)
            else: low_l.setVisible(False)
            
            if left_vis[3]: grid_layout.addWidget(qual_l, r, 6)
            else: qual_l.setVisible(False)
            
            # Right Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_r = QLineEdit("0.0")
                nom_r.setAlignment(Qt.AlignRight)
            else:
                nom_r = QLabel("0.0")
                nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_r = QLineEdit("0.0")
            low_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_r.setAlignment(Qt.AlignRight)
            low_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            if right_vis[0]: grid_layout.addWidget(nom_r, r, 8)
            else: nom_r.setVisible(False)
            
            if right_vis[1]: grid_layout.addWidget(upp_r, r, 9)
            else: upp_r.setVisible(False)
            
            if right_vis[2]: grid_layout.addWidget(low_r, r, 10)
            else: low_r.setVisible(False)
            
            if right_vis[3]: grid_layout.addWidget(qual_r, r, 11)
            else: qual_r.setVisible(False)
            
            # Store references
            self.profile_inputs[code] = {
                "left": {"nom": nom_l, "upp": upp_l, "low": low_l, "qual": qual_l},
                "right": {"nom": nom_r, "upp": upp_r, "low": low_r, "qual": qual_r}
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right) - under left section
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "profile"))
        
        # Left Copy Button (Right to Left) - under right section
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "profile"))
        
        # Add buttons to grid
        # Centered under the respective sections
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Under Left section? No, usually arrows point direction.
        # Ref image shows arrows at bottom.
        # Left arrow is under Right section pointing Left? Or under Left section?
        # Image 1 shows:
        # Left side has "Ba ->" (Left to Right?) No, wait.
        # Image 1 shows:
        # Under Left section: Arrow pointing RIGHT (Ba ->)
        # Under Right section: Arrow pointing LEFT (<- Ba)
        # Wait, usually "Ba ->" means Copy FROM Ba TO other?
        # Let's assume:
        # Button under Left section: Copy Left -> Right
        # Button under Right section: Copy Right -> Left
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Left side, arrow pointing right
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter) # Right side, arrow pointing left
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)

    def create_din3962_lead_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN 3962 Lead"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.lead_quality_spin = QSpinBox()
        self.lead_quality_spin.setRange(1, 12)
        self.lead_quality_spin.setValue(5)
        self.lead_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.lead_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }""")
        set_btn.clicked.connect(lambda: self.calculate_tolerances("lead"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Add Lead Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "lead_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            # Scale to reasonable height if needed, e.g. 60px
            if pixmap.height() > 60:
                pixmap = pixmap.scaledToHeight(60, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Table Frame
        table_frame = QFrame()
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.lead_btn_lim_upp_l = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_l = QPushButton("Lim. low.")
        self.lead_btn_qual_l = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_l, self.lead_btn_lim_low_l, self.lead_btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_l.setChecked(True)
        self.lead_btn_lim_low_l.setChecked(True)
        self.lead_btn_qual_l.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_lim_low_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_qual_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.lead_btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.lead_btn_qual_l, 1, 6)
        
        # Right Side Headers
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.lead_btn_lim_upp_r = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_r = QPushButton("Lim. low.")
        self.lead_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_r, self.lead_btn_lim_low_r, self.lead_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_r.setChecked(True)
        self.lead_btn_lim_low_r.setChecked(True)
        self.lead_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_lim_low_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_qual_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.lead_btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.lead_btn_qual_r, 1, 11)
        
        # Data Rows
        self.lead_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_is_label: True=QLabel (no border), False=QLineEdit)
        rows = [
            ("Angular error", "fHb", True, [True, True, True, True], [True, True, True, True], True),
            ("Variance Ang.err.", "Var", True, [False, True, False, False], [False, True, False, False], False),
            ("Total error", "Fb", True, [False, True, False, True], [False, True, False, True], False),
            ("Form error", "ffb", True, [False, True, False, True], [False, True, False, True], False),
            ("Crowning", "Cb", True, [True, True, True, False], [True, True, True, False], True),
            ("Top-relief (lead)", "fo", True, [True, True, True, False], [True, True, True, False], True),
            ("Bottom-relief (lead)", "fu", True, [True, True, True, False], [True, True, True, False], True),
            ("Bending", "FV", True, [True, True, True, False], [True, True, True, False], False)
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_is_label) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.lead_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            left_widgets = {}
            
            if left_vis[0]: # Nom
                if nom_is_label:
                    nom_l = QLabel("0.0")
                    nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_l = QLineEdit("0.0")
                    nom_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_l, r, 3)
                left_widgets["nom"] = nom_l
            
            if left_vis[1]: # Upp
                upp_l = QLineEdit("0.0")
                upp_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_l, r, 4)
                left_widgets["upp"] = upp_l
                
            if left_vis[2]: # Low
                low_l = QLineEdit("0.0")
                low_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_l, r, 5)
                left_widgets["low"] = low_l
                
            if left_vis[3]: # Qual
                qual_l = QLineEdit("5")
                qual_l.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_l, r, 6)
                left_widgets["qual"] = qual_l
            
            # Right Side inputs
            right_widgets = {}
            
            if right_vis[0]: # Nom
                if nom_is_label:
                    nom_r = QLabel("0.0")
                    nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_r = QLineEdit("0.0")
                    nom_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_r, r, 8)
                right_widgets["nom"] = nom_r
                
            if right_vis[1]: # Upp
                upp_r = QLineEdit("0.0")
                upp_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_r, r, 9)
                right_widgets["upp"] = upp_r
                
            if right_vis[2]: # Low
                low_r = QLineEdit("0.0")
                low_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_r, r, 10)
                right_widgets["low"] = low_r
                
            if right_vis[3]: # Qual
                qual_r = QLineEdit("5")
                qual_r.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_r, r, 11)
                right_widgets["qual"] = qual_r
            
            # Store references
            self.lead_inputs[code] = {
                "left": left_widgets,
                "right": right_widgets
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right)
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "lead"))
        
        # Left Copy Button (Right to Left)
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "lead"))
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter)
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter)
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize field states
        self.toggle_lead_header_mode("left", "limits")
        self.toggle_lead_header_mode("right", "limits")

    def create_din3962_spacing_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN 3962 Spacing"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
            QGroupBox {
                border: 1px solid #808080;
                margin-top: 10px;
                font-weight: normal;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 3px;
                left: 10px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.spacing_quality_spin = QSpinBox()
        self.spacing_quality_spin.setRange(1, 12)
        self.spacing_quality_spin.setValue(5)
        self.spacing_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.spacing_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("spacing"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Spacing Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "spacing_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            if pixmap.height() > 80:
                pixmap = pixmap.scaledToHeight(80, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        else:
            # Placeholder if no icon
            icon_label.setText("Spacing")
            icon_label.setStyleSheet("border: 1px solid #ccc; background: white; padding: 5px;")
            icon_label.setFixedSize(80, 80)
            icon_label.setAlignment(Qt.AlignCenter)
            
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Spacing Group
        spacing_group = QGroupBox("Spacing")
        spacing_layout = QGridLayout(spacing_group)
        spacing_layout.setSpacing(5)
        spacing_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        spacing_layout.addWidget(QLabel("left"), 0, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(QLabel("right"), 0, 5, 1, 2, Qt.AlignCenter)
        
        # Add vertical separator
        sep = QFrame()
        sep.setFrameShape(QFrame.VLine)
        sep.setFrameShadow(QFrame.Sunken)
        sep.setStyleSheet("color: #808080;")
        spacing_layout.addWidget(sep, 0, 4, 7, 1) # Span down to cover rows
        
        # Buttons/Headers
        self.spacing_btn_lim_l = QPushButton("Lim. upp.")
        self.spacing_btn_qual_l = QPushButton("Quality")
        self.spacing_btn_lim_r = QPushButton("Lim. upp.")
        self.spacing_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.spacing_btn_lim_l, self.spacing_btn_qual_l, self.spacing_btn_lim_r, self.spacing_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.spacing_btn_lim_l.setChecked(True)
        self.spacing_btn_qual_l.setChecked(False)
        self.spacing_btn_lim_r.setChecked(True)
        self.spacing_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.spacing_btn_lim_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "limits"))
        self.spacing_btn_qual_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "quality"))
        self.spacing_btn_lim_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "limits"))
        self.spacing_btn_qual_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "quality"))
        
        spacing_layout.addWidget(self.spacing_btn_lim_l, 1, 2)
        spacing_layout.addWidget(self.spacing_btn_qual_l, 1, 3)
        spacing_layout.addWidget(self.spacing_btn_lim_r, 1, 5)
        spacing_layout.addWidget(self.spacing_btn_qual_r, 1, 6)
        
        self.spacing_inputs = {}
        rows = [
            ("Individual error", "fp"),
            ("Pitch jump", "fu"),
            ("Total error", "Fp"),
            ("Pitch-span var.", "Fpz/8")
        ]
        
        for r, (label, code) in enumerate(rows):
            row_idx = r + 2
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            spacing_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            upp_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            upp_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            spacing_layout.addWidget(upp_l, row_idx, 2)
            spacing_layout.addWidget(qual_l, row_idx, 3)
            spacing_layout.addWidget(upp_r, row_idx, 5)
            spacing_layout.addWidget(qual_r, row_idx, 6)
            
            self.spacing_inputs[code] = {
                "left": {"upp": upp_l, "qual": qual_l},
                "right": {"upp": upp_r, "qual": qual_r}
            }
            
        # Copy Buttons
        copy_row = len(rows) + 2
        
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover { background-color: #e0e0ff; }
            QPushButton:pressed { border: 2px inset #a0a0a0; background-color: #d0d0d0; }
        """
        
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(60, 30)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "spacing"))
        
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(60, 30)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "spacing"))
        
        spacing_layout.addWidget(copy_r_btn, copy_row, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(copy_l_btn, copy_row, 5, 1, 2, Qt.AlignCenter)
            
        layout.addWidget(spacing_group)
        
        # Run-out Group
        runout_group = QGroupBox("Run-out / Tooth thickness")
        runout_layout = QGridLayout(runout_group)
        runout_layout.setSpacing(5)
        runout_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        self.runout_btn_lim = QPushButton("Lim. upp.")
        self.runout_btn_qual = QPushButton("Quality")
        
        for btn in [self.runout_btn_lim, self.runout_btn_qual]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.runout_btn_lim.setChecked(True)
        self.runout_btn_qual.setChecked(False)
        
        # Connect signals
        self.runout_btn_lim.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "limits"))
        self.runout_btn_qual.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "quality"))
        
        runout_layout.addWidget(self.runout_btn_lim, 0, 2)
        runout_layout.addWidget(self.runout_btn_qual, 0, 3)
        
        rows_runout = [
            ("Run-out", "Fr"),
            ("Variation of tooth thickness", "Rs")
        ]
        
        for r, (label, code) in enumerate(rows_runout):
            row_idx = r + 1
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            runout_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp = QLineEdit("0.0")
            qual = QLineEdit("5")
            
            upp.setAlignment(Qt.AlignRight)
            qual.setAlignment(Qt.AlignCenter)
            
            runout_layout.addWidget(upp, row_idx, 2)
            runout_layout.addWidget(qual, row_idx, 3)
            
            self.spacing_inputs[code] = {"upp": upp, "qual": qual}
            
        layout.addWidget(runout_group)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
            
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize
        self.toggle_spacing_header_mode("left", "limits")
        self.toggle_spacing_header_mode("right", "limits")
        self.toggle_spacing_header_mode("runout", "limits")

    def create_agma_profile_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        # Using a gray color to match the MDI style
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800) # Set a reasonable fixed width or let it expand
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon (Blue diamond/logo placeholder)
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to AGMA Profile"))
        title_layout.addStretch()
        
        # Window Controls
        # Minimize/Maximize buttons (Visual only)
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.profile_quality_spin = QSpinBox()
        self.quality_spins["AGMA_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 5480_Profile"] = self.profile_quality_spin
        self.quality_spins["ANSI B92.1_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 2013_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 1997_Profile"] = self.profile_quality_spin
        self.quality_spins["AGMA_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 3962_Profile"] = self.profile_quality_spin
        self.profile_quality_spin.setRange(1, 12)
        self.profile_quality_spin.setValue(5)
        self.profile_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.profile_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("profile"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Tooth Profile Icon
        icon_label = QLabel()
        # Use relative path for portability
        current_dir = os.path.dirname(os.path.abspath(__file__))
        icon_path = os.path.join(current_dir, "resources", "profile_tolerance_icon.png")
        
        try:
            from PyQt5.QtGui import QPixmap
            pixmap = QPixmap(icon_path)
            if not pixmap.isNull():
                # Increased size to 100x100 as requested
                icon_label.setPixmap(pixmap.scaled(100, 100, Qt.KeepAspectRatio, Qt.SmoothTransformation))
            else:
                # Fallback if image not found
                icon_label.setText("Profile")
                icon_label.setAlignment(Qt.AlignCenter)
                icon_label.setFixedSize(100, 100)
        except Exception as e:
            print(f"Error loading icon: {e}")
            icon_label.setText("Icon")
            icon_label.setFixedSize(100, 100)
            
        icon_label.setStyleSheet("background-color: white; border: 1px solid #ccc; padding: 5px;")
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        layout.addSpacing(10)
        
        # Main Table Frame
        table_frame = QFrame()
        table_frame.setFrameShape(QFrame.Box)
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        # Nom. val is a Label
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.btn_lim_upp_l = QPushButton("Lim. upp.")
        self.btn_lim_low_l = QPushButton("Lim. low.")
        self.btn_qual_l = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_l, self.btn_lim_low_l, self.btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_l.setChecked(True)
        self.btn_lim_low_l.setChecked(True)
        self.btn_qual_l.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_lim_low_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_qual_l.clicked.connect(lambda: self.toggle_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.btn_qual_l, 1, 6)
        
        # Right Side Headers
        # Nom. val is a Label
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.btn_lim_upp_r = QPushButton("Lim. upp.")
        self.btn_lim_low_r = QPushButton("Lim. low.")
        self.btn_qual_r = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_r, self.btn_lim_low_r, self.btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_r.setChecked(True)
        self.btn_lim_low_r.setChecked(True)
        self.btn_qual_r.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_lim_low_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_qual_r.clicked.connect(lambda: self.toggle_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.btn_qual_r, 1, 11)
        
        # Data Rows
        self.profile_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_Editable: True=QLineEdit, False=QLabel)
        # True = Visible, False = Hidden
        rows = [
            ("Angular error", "fHa", True, 
             [True, True, True, True], [True, True, True, True], False), # All visible, Nom not editable
            ("Variance Ang.err.", "Var", True, 
             [False, True, False, False], [False, True, False, False], False), # Nom, Low, Qual hidden
            ("Total error", "Fa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Form error", "ffa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Crowning", "Ca", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Tip-relief", "fKo", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Root-relief", "fFu", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Profile twist", "PV", True, 
             [True, True, True, False], [True, True, True, False], True)  # Qual hidden, Nom EDITABLE
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_editable) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.profile_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_l = QLineEdit("0.0")
                nom_l.setAlignment(Qt.AlignRight)
            else:
                nom_l = QLabel("0.0")
                nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_l = QLineEdit("0.0")
            low_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            low_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            
            if left_vis[0]: grid_layout.addWidget(nom_l, r, 3)
            else: nom_l.setVisible(False)
            
            if left_vis[1]: grid_layout.addWidget(upp_l, r, 4)
            else: upp_l.setVisible(False)
            
            if left_vis[2]: grid_layout.addWidget(low_l, r, 5)
            else: low_l.setVisible(False)
            
            if left_vis[3]: grid_layout.addWidget(qual_l, r, 6)
            else: qual_l.setVisible(False)
            
            # Right Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_r = QLineEdit("0.0")
                nom_r.setAlignment(Qt.AlignRight)
            else:
                nom_r = QLabel("0.0")
                nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_r = QLineEdit("0.0")
            low_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_r.setAlignment(Qt.AlignRight)
            low_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            if right_vis[0]: grid_layout.addWidget(nom_r, r, 8)
            else: nom_r.setVisible(False)
            
            if right_vis[1]: grid_layout.addWidget(upp_r, r, 9)
            else: upp_r.setVisible(False)
            
            if right_vis[2]: grid_layout.addWidget(low_r, r, 10)
            else: low_r.setVisible(False)
            
            if right_vis[3]: grid_layout.addWidget(qual_r, r, 11)
            else: qual_r.setVisible(False)
            
            # Store references
            self.profile_inputs[code] = {
                "left": {"nom": nom_l, "upp": upp_l, "low": low_l, "qual": qual_l},
                "right": {"nom": nom_r, "upp": upp_r, "low": low_r, "qual": qual_r}
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right) - under left section
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "profile"))
        
        # Left Copy Button (Right to Left) - under right section
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "profile"))
        
        # Add buttons to grid
        # Centered under the respective sections
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Under Left section? No, usually arrows point direction.
        # Ref image shows arrows at bottom.
        # Left arrow is under Right section pointing Left? Or under Left section?
        # Image 1 shows:
        # Left side has "Ba ->" (Left to Right?) No, wait.
        # Image 1 shows:
        # Under Left section: Arrow pointing RIGHT (Ba ->)
        # Under Right section: Arrow pointing LEFT (<- Ba)
        # Wait, usually "Ba ->" means Copy FROM Ba TO other?
        # Let's assume:
        # Button under Left section: Copy Left -> Right
        # Button under Right section: Copy Right -> Left
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Left side, arrow pointing right
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter) # Right side, arrow pointing left
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)

    def create_agma_lead_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN 3962 Lead"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.lead_quality_spin = QSpinBox()
        self.lead_quality_spin.setRange(1, 12)
        self.lead_quality_spin.setValue(5)
        self.lead_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.lead_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }""")
        set_btn.clicked.connect(lambda: self.calculate_tolerances("lead"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Add Lead Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "lead_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            # Scale to reasonable height if needed, e.g. 60px
            if pixmap.height() > 60:
                pixmap = pixmap.scaledToHeight(60, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Table Frame
        table_frame = QFrame()
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.lead_btn_lim_upp_l = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_l = QPushButton("Lim. low.")
        self.lead_btn_qual_l = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_l, self.lead_btn_lim_low_l, self.lead_btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_l.setChecked(True)
        self.lead_btn_lim_low_l.setChecked(True)
        self.lead_btn_qual_l.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_lim_low_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_qual_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.lead_btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.lead_btn_qual_l, 1, 6)
        
        # Right Side Headers
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.lead_btn_lim_upp_r = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_r = QPushButton("Lim. low.")
        self.lead_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_r, self.lead_btn_lim_low_r, self.lead_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_r.setChecked(True)
        self.lead_btn_lim_low_r.setChecked(True)
        self.lead_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_lim_low_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_qual_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.lead_btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.lead_btn_qual_r, 1, 11)
        
        # Data Rows
        self.lead_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_is_label: True=QLabel (no border), False=QLineEdit)
        rows = [
            ("Angular error", "fHb", True, [True, True, True, True], [True, True, True, True], True),
            ("Variance Ang.err.", "Var", True, [False, True, False, False], [False, True, False, False], False),
            ("Total error", "Fb", True, [False, True, False, True], [False, True, False, True], False),
            ("Form error", "ffb", True, [False, True, False, True], [False, True, False, True], False),
            ("Crowning", "Cb", True, [True, True, True, False], [True, True, True, False], True),
            ("Top-relief (lead)", "fo", True, [True, True, True, False], [True, True, True, False], True),
            ("Bottom-relief (lead)", "fu", True, [True, True, True, False], [True, True, True, False], True),
            ("Bending", "FV", True, [True, True, True, False], [True, True, True, False], False)
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_is_label) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.lead_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            left_widgets = {}
            
            if left_vis[0]: # Nom
                if nom_is_label:
                    nom_l = QLabel("0.0")
                    nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_l = QLineEdit("0.0")
                    nom_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_l, r, 3)
                left_widgets["nom"] = nom_l
            
            if left_vis[1]: # Upp
                upp_l = QLineEdit("0.0")
                upp_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_l, r, 4)
                left_widgets["upp"] = upp_l
                
            if left_vis[2]: # Low
                low_l = QLineEdit("0.0")
                low_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_l, r, 5)
                left_widgets["low"] = low_l
                
            if left_vis[3]: # Qual
                qual_l = QLineEdit("5")
                qual_l.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_l, r, 6)
                left_widgets["qual"] = qual_l
            
            # Right Side inputs
            right_widgets = {}
            
            if right_vis[0]: # Nom
                if nom_is_label:
                    nom_r = QLabel("0.0")
                    nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_r = QLineEdit("0.0")
                    nom_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_r, r, 8)
                right_widgets["nom"] = nom_r
                
            if right_vis[1]: # Upp
                upp_r = QLineEdit("0.0")
                upp_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_r, r, 9)
                right_widgets["upp"] = upp_r
                
            if right_vis[2]: # Low
                low_r = QLineEdit("0.0")
                low_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_r, r, 10)
                right_widgets["low"] = low_r
                
            if right_vis[3]: # Qual
                qual_r = QLineEdit("5")
                qual_r.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_r, r, 11)
                right_widgets["qual"] = qual_r
            
            # Store references
            self.lead_inputs[code] = {
                "left": left_widgets,
                "right": right_widgets
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right)
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "lead"))
        
        # Left Copy Button (Right to Left)
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "lead"))
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter)
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter)
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize field states
        self.toggle_lead_header_mode("left", "limits")
        self.toggle_lead_header_mode("right", "limits")

    def create_agma_spacing_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to AGMA Spacing"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
            QGroupBox {
                border: 1px solid #808080;
                margin-top: 10px;
                font-weight: normal;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 3px;
                left: 10px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.spacing_quality_spin = QSpinBox()
        self.spacing_quality_spin.setRange(1, 12)
        self.spacing_quality_spin.setValue(5)
        self.spacing_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.spacing_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("spacing"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Spacing Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "spacing_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            if pixmap.height() > 80:
                pixmap = pixmap.scaledToHeight(80, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        else:
            # Placeholder if no icon
            icon_label.setText("Spacing")
            icon_label.setStyleSheet("border: 1px solid #ccc; background: white; padding: 5px;")
            icon_label.setFixedSize(80, 80)
            icon_label.setAlignment(Qt.AlignCenter)
            
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Spacing Group
        spacing_group = QGroupBox("Spacing")
        spacing_layout = QGridLayout(spacing_group)
        spacing_layout.setSpacing(5)
        spacing_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        spacing_layout.addWidget(QLabel("left"), 0, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(QLabel("right"), 0, 5, 1, 2, Qt.AlignCenter)
        
        # Add vertical separator
        sep = QFrame()
        sep.setFrameShape(QFrame.VLine)
        sep.setFrameShadow(QFrame.Sunken)
        sep.setStyleSheet("color: #808080;")
        spacing_layout.addWidget(sep, 0, 4, 7, 1) # Span down to cover rows
        
        # Buttons/Headers
        self.spacing_btn_lim_l = QPushButton("Lim. upp.")
        self.spacing_btn_qual_l = QPushButton("Quality")
        self.spacing_btn_lim_r = QPushButton("Lim. upp.")
        self.spacing_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.spacing_btn_lim_l, self.spacing_btn_qual_l, self.spacing_btn_lim_r, self.spacing_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.spacing_btn_lim_l.setChecked(True)
        self.spacing_btn_qual_l.setChecked(False)
        self.spacing_btn_lim_r.setChecked(True)
        self.spacing_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.spacing_btn_lim_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "limits"))
        self.spacing_btn_qual_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "quality"))
        self.spacing_btn_lim_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "limits"))
        self.spacing_btn_qual_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "quality"))
        
        spacing_layout.addWidget(self.spacing_btn_lim_l, 1, 2)
        spacing_layout.addWidget(self.spacing_btn_qual_l, 1, 3)
        spacing_layout.addWidget(self.spacing_btn_lim_r, 1, 5)
        spacing_layout.addWidget(self.spacing_btn_qual_r, 1, 6)
        
        self.spacing_inputs = {}
        rows = [
            ("Individual error", "fp"),
            ("Pitch jump", "fu"),
            ("Total error", "Fp"),
            ("Pitch-span var.", "Fpz/8")
        ]
        
        for r, (label, code) in enumerate(rows):
            row_idx = r + 2
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            spacing_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            upp_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            upp_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            spacing_layout.addWidget(upp_l, row_idx, 2)
            spacing_layout.addWidget(qual_l, row_idx, 3)
            spacing_layout.addWidget(upp_r, row_idx, 5)
            spacing_layout.addWidget(qual_r, row_idx, 6)
            
            self.spacing_inputs[code] = {
                "left": {"upp": upp_l, "qual": qual_l},
                "right": {"upp": upp_r, "qual": qual_r}
            }
            
        # Copy Buttons
        copy_row = len(rows) + 2
        
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover { background-color: #e0e0ff; }
            QPushButton:pressed { border: 2px inset #a0a0a0; background-color: #d0d0d0; }
        """
        
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(60, 30)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "spacing"))
        
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(60, 30)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "spacing"))
        
        spacing_layout.addWidget(copy_r_btn, copy_row, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(copy_l_btn, copy_row, 5, 1, 2, Qt.AlignCenter)
            
        layout.addWidget(spacing_group)
        
        # Run-out Group
        runout_group = QGroupBox("Run-out / Tooth thickness")
        runout_layout = QGridLayout(runout_group)
        runout_layout.setSpacing(5)
        runout_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        self.runout_btn_lim = QPushButton("Lim. upp.")
        self.runout_btn_qual = QPushButton("Quality")
        
        for btn in [self.runout_btn_lim, self.runout_btn_qual]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.runout_btn_lim.setChecked(True)
        self.runout_btn_qual.setChecked(False)
        
        # Connect signals
        self.runout_btn_lim.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "limits"))
        self.runout_btn_qual.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "quality"))
        
        runout_layout.addWidget(self.runout_btn_lim, 0, 2)
        runout_layout.addWidget(self.runout_btn_qual, 0, 3)
        
        rows_runout = [
            ("Run-out", "Fr"),
            ("Variation of tooth thickness", "Rs")
        ]
        
        for r, (label, code) in enumerate(rows_runout):
            row_idx = r + 1
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            runout_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp = QLineEdit("0.0")
            qual = QLineEdit("5")
            
            upp.setAlignment(Qt.AlignRight)
            qual.setAlignment(Qt.AlignCenter)
            
            runout_layout.addWidget(upp, row_idx, 2)
            runout_layout.addWidget(qual, row_idx, 3)
            
            self.spacing_inputs[code] = {"upp": upp, "qual": qual}
            
        layout.addWidget(runout_group)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
            
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize
        self.toggle_spacing_header_mode("left", "limits")
        self.toggle_spacing_header_mode("right", "limits")
        self.toggle_spacing_header_mode("runout", "limits")

    def create_iso1328_1997_profile_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        # Using a gray color to match the MDI style
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800) # Set a reasonable fixed width or let it expand
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon (Blue diamond/logo placeholder)
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to ISO 1328 : 1997 Profile"))
        title_layout.addStretch()
        
        # Window Controls
        # Minimize/Maximize buttons (Visual only)
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.profile_quality_spin = QSpinBox()
        self.quality_spins["ISO 1328 : 1997_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 5480_Profile"] = self.profile_quality_spin
        self.quality_spins["ANSI B92.1_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 2013_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 1997_Profile"] = self.profile_quality_spin
        self.quality_spins["AGMA_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 3962_Profile"] = self.profile_quality_spin
        self.profile_quality_spin.setRange(1, 12)
        self.profile_quality_spin.setValue(5)
        self.profile_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.profile_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("profile"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Tooth Profile Icon
        icon_label = QLabel()
        # Use relative path for portability
        current_dir = os.path.dirname(os.path.abspath(__file__))
        icon_path = os.path.join(current_dir, "resources", "profile_tolerance_icon.png")
        
        try:
            from PyQt5.QtGui import QPixmap
            pixmap = QPixmap(icon_path)
            if not pixmap.isNull():
                # Increased size to 100x100 as requested
                icon_label.setPixmap(pixmap.scaled(100, 100, Qt.KeepAspectRatio, Qt.SmoothTransformation))
            else:
                # Fallback if image not found
                icon_label.setText("Profile")
                icon_label.setAlignment(Qt.AlignCenter)
                icon_label.setFixedSize(100, 100)
        except Exception as e:
            print(f"Error loading icon: {e}")
            icon_label.setText("Icon")
            icon_label.setFixedSize(100, 100)
            
        icon_label.setStyleSheet("background-color: white; border: 1px solid #ccc; padding: 5px;")
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        layout.addSpacing(10)
        
        # Main Table Frame
        table_frame = QFrame()
        table_frame.setFrameShape(QFrame.Box)
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        # Nom. val is a Label
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.btn_lim_upp_l = QPushButton("Lim. upp.")
        self.btn_lim_low_l = QPushButton("Lim. low.")
        self.btn_qual_l = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_l, self.btn_lim_low_l, self.btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_l.setChecked(True)
        self.btn_lim_low_l.setChecked(True)
        self.btn_qual_l.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_lim_low_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_qual_l.clicked.connect(lambda: self.toggle_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.btn_qual_l, 1, 6)
        
        # Right Side Headers
        # Nom. val is a Label
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.btn_lim_upp_r = QPushButton("Lim. upp.")
        self.btn_lim_low_r = QPushButton("Lim. low.")
        self.btn_qual_r = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_r, self.btn_lim_low_r, self.btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_r.setChecked(True)
        self.btn_lim_low_r.setChecked(True)
        self.btn_qual_r.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_lim_low_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_qual_r.clicked.connect(lambda: self.toggle_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.btn_qual_r, 1, 11)
        
        # Data Rows
        self.profile_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_Editable: True=QLineEdit, False=QLabel)
        # True = Visible, False = Hidden
        rows = [
            ("Angular error", "fHa", True, 
             [True, True, True, True], [True, True, True, True], False), # All visible, Nom not editable
            ("Variance Ang.err.", "Var", True, 
             [False, True, False, False], [False, True, False, False], False), # Nom, Low, Qual hidden
            ("Total error", "Fa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Form error", "ffa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Crowning", "Ca", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Tip-relief", "fKo", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Root-relief", "fFu", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Profile twist", "PV", True, 
             [True, True, True, False], [True, True, True, False], True)  # Qual hidden, Nom EDITABLE
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_editable) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.profile_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_l = QLineEdit("0.0")
                nom_l.setAlignment(Qt.AlignRight)
            else:
                nom_l = QLabel("0.0")
                nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_l = QLineEdit("0.0")
            low_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            low_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            
            if left_vis[0]: grid_layout.addWidget(nom_l, r, 3)
            else: nom_l.setVisible(False)
            
            if left_vis[1]: grid_layout.addWidget(upp_l, r, 4)
            else: upp_l.setVisible(False)
            
            if left_vis[2]: grid_layout.addWidget(low_l, r, 5)
            else: low_l.setVisible(False)
            
            if left_vis[3]: grid_layout.addWidget(qual_l, r, 6)
            else: qual_l.setVisible(False)
            
            # Right Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_r = QLineEdit("0.0")
                nom_r.setAlignment(Qt.AlignRight)
            else:
                nom_r = QLabel("0.0")
                nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_r = QLineEdit("0.0")
            low_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_r.setAlignment(Qt.AlignRight)
            low_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            if right_vis[0]: grid_layout.addWidget(nom_r, r, 8)
            else: nom_r.setVisible(False)
            
            if right_vis[1]: grid_layout.addWidget(upp_r, r, 9)
            else: upp_r.setVisible(False)
            
            if right_vis[2]: grid_layout.addWidget(low_r, r, 10)
            else: low_r.setVisible(False)
            
            if right_vis[3]: grid_layout.addWidget(qual_r, r, 11)
            else: qual_r.setVisible(False)
            
            # Store references
            self.profile_inputs[code] = {
                "left": {"nom": nom_l, "upp": upp_l, "low": low_l, "qual": qual_l},
                "right": {"nom": nom_r, "upp": upp_r, "low": low_r, "qual": qual_r}
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right) - under left section
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "profile"))
        
        # Left Copy Button (Right to Left) - under right section
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "profile"))
        
        # Add buttons to grid
        # Centered under the respective sections
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Under Left section? No, usually arrows point direction.
        # Ref image shows arrows at bottom.
        # Left arrow is under Right section pointing Left? Or under Left section?
        # Image 1 shows:
        # Left side has "Ba ->" (Left to Right?) No, wait.
        # Image 1 shows:
        # Under Left section: Arrow pointing RIGHT (Ba ->)
        # Under Right section: Arrow pointing LEFT (<- Ba)
        # Wait, usually "Ba ->" means Copy FROM Ba TO other?
        # Let's assume:
        # Button under Left section: Copy Left -> Right
        # Button under Right section: Copy Right -> Left
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Left side, arrow pointing right
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter) # Right side, arrow pointing left
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)

    def create_iso1328_1997_lead_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN 3962 Lead"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.lead_quality_spin = QSpinBox()
        self.lead_quality_spin.setRange(1, 12)
        self.lead_quality_spin.setValue(5)
        self.lead_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.lead_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }""")
        set_btn.clicked.connect(lambda: self.calculate_tolerances("lead"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Add Lead Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "lead_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            # Scale to reasonable height if needed, e.g. 60px
            if pixmap.height() > 60:
                pixmap = pixmap.scaledToHeight(60, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Table Frame
        table_frame = QFrame()
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.lead_btn_lim_upp_l = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_l = QPushButton("Lim. low.")
        self.lead_btn_qual_l = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_l, self.lead_btn_lim_low_l, self.lead_btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_l.setChecked(True)
        self.lead_btn_lim_low_l.setChecked(True)
        self.lead_btn_qual_l.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_lim_low_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_qual_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.lead_btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.lead_btn_qual_l, 1, 6)
        
        # Right Side Headers
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.lead_btn_lim_upp_r = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_r = QPushButton("Lim. low.")
        self.lead_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_r, self.lead_btn_lim_low_r, self.lead_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_r.setChecked(True)
        self.lead_btn_lim_low_r.setChecked(True)
        self.lead_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_lim_low_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_qual_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.lead_btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.lead_btn_qual_r, 1, 11)
        
        # Data Rows
        self.lead_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_is_label: True=QLabel (no border), False=QLineEdit)
        rows = [
            ("Angular error", "fHb", True, [True, True, True, True], [True, True, True, True], True),
            ("Variance Ang.err.", "Var", True, [False, True, False, False], [False, True, False, False], False),
            ("Total error", "Fb", True, [False, True, False, True], [False, True, False, True], False),
            ("Form error", "ffb", True, [False, True, False, True], [False, True, False, True], False),
            ("Crowning", "Cb", True, [True, True, True, False], [True, True, True, False], True),
            ("Top-relief (lead)", "fo", True, [True, True, True, False], [True, True, True, False], True),
            ("Bottom-relief (lead)", "fu", True, [True, True, True, False], [True, True, True, False], True),
            ("Bending", "FV", True, [True, True, True, False], [True, True, True, False], False)
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_is_label) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.lead_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            left_widgets = {}
            
            if left_vis[0]: # Nom
                if nom_is_label:
                    nom_l = QLabel("0.0")
                    nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_l = QLineEdit("0.0")
                    nom_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_l, r, 3)
                left_widgets["nom"] = nom_l
            
            if left_vis[1]: # Upp
                upp_l = QLineEdit("0.0")
                upp_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_l, r, 4)
                left_widgets["upp"] = upp_l
                
            if left_vis[2]: # Low
                low_l = QLineEdit("0.0")
                low_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_l, r, 5)
                left_widgets["low"] = low_l
                
            if left_vis[3]: # Qual
                qual_l = QLineEdit("5")
                qual_l.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_l, r, 6)
                left_widgets["qual"] = qual_l
            
            # Right Side inputs
            right_widgets = {}
            
            if right_vis[0]: # Nom
                if nom_is_label:
                    nom_r = QLabel("0.0")
                    nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_r = QLineEdit("0.0")
                    nom_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_r, r, 8)
                right_widgets["nom"] = nom_r
                
            if right_vis[1]: # Upp
                upp_r = QLineEdit("0.0")
                upp_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_r, r, 9)
                right_widgets["upp"] = upp_r
                
            if right_vis[2]: # Low
                low_r = QLineEdit("0.0")
                low_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_r, r, 10)
                right_widgets["low"] = low_r
                
            if right_vis[3]: # Qual
                qual_r = QLineEdit("5")
                qual_r.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_r, r, 11)
                right_widgets["qual"] = qual_r
            
            # Store references
            self.lead_inputs[code] = {
                "left": left_widgets,
                "right": right_widgets
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right)
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "lead"))
        
        # Left Copy Button (Right to Left)
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "lead"))
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter)
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter)
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize field states
        self.toggle_lead_header_mode("left", "limits")
        self.toggle_lead_header_mode("right", "limits")

    def create_iso1328_1997_spacing_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to ISO 1328 : 1997 Spacing"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
            QGroupBox {
                border: 1px solid #808080;
                margin-top: 10px;
                font-weight: normal;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 3px;
                left: 10px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.spacing_quality_spin = QSpinBox()
        self.spacing_quality_spin.setRange(1, 12)
        self.spacing_quality_spin.setValue(5)
        self.spacing_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.spacing_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("spacing"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Spacing Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "spacing_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            if pixmap.height() > 80:
                pixmap = pixmap.scaledToHeight(80, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        else:
            # Placeholder if no icon
            icon_label.setText("Spacing")
            icon_label.setStyleSheet("border: 1px solid #ccc; background: white; padding: 5px;")
            icon_label.setFixedSize(80, 80)
            icon_label.setAlignment(Qt.AlignCenter)
            
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Spacing Group
        spacing_group = QGroupBox("Spacing")
        spacing_layout = QGridLayout(spacing_group)
        spacing_layout.setSpacing(5)
        spacing_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        spacing_layout.addWidget(QLabel("left"), 0, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(QLabel("right"), 0, 5, 1, 2, Qt.AlignCenter)
        
        # Add vertical separator
        sep = QFrame()
        sep.setFrameShape(QFrame.VLine)
        sep.setFrameShadow(QFrame.Sunken)
        sep.setStyleSheet("color: #808080;")
        spacing_layout.addWidget(sep, 0, 4, 7, 1) # Span down to cover rows
        
        # Buttons/Headers
        self.spacing_btn_lim_l = QPushButton("Lim. upp.")
        self.spacing_btn_qual_l = QPushButton("Quality")
        self.spacing_btn_lim_r = QPushButton("Lim. upp.")
        self.spacing_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.spacing_btn_lim_l, self.spacing_btn_qual_l, self.spacing_btn_lim_r, self.spacing_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.spacing_btn_lim_l.setChecked(True)
        self.spacing_btn_qual_l.setChecked(False)
        self.spacing_btn_lim_r.setChecked(True)
        self.spacing_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.spacing_btn_lim_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "limits"))
        self.spacing_btn_qual_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "quality"))
        self.spacing_btn_lim_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "limits"))
        self.spacing_btn_qual_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "quality"))
        
        spacing_layout.addWidget(self.spacing_btn_lim_l, 1, 2)
        spacing_layout.addWidget(self.spacing_btn_qual_l, 1, 3)
        spacing_layout.addWidget(self.spacing_btn_lim_r, 1, 5)
        spacing_layout.addWidget(self.spacing_btn_qual_r, 1, 6)
        
        self.spacing_inputs = {}
        rows = [
            ("Individual error", "fp"),
            ("Pitch jump", "fu"),
            ("Total error", "Fp"),
            ("Pitch-span var.", "Fpz/8")
        ]
        
        for r, (label, code) in enumerate(rows):
            row_idx = r + 2
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            spacing_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            upp_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            upp_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            spacing_layout.addWidget(upp_l, row_idx, 2)
            spacing_layout.addWidget(qual_l, row_idx, 3)
            spacing_layout.addWidget(upp_r, row_idx, 5)
            spacing_layout.addWidget(qual_r, row_idx, 6)
            
            self.spacing_inputs[code] = {
                "left": {"upp": upp_l, "qual": qual_l},
                "right": {"upp": upp_r, "qual": qual_r}
            }
            
        # Copy Buttons
        copy_row = len(rows) + 2
        
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover { background-color: #e0e0ff; }
            QPushButton:pressed { border: 2px inset #a0a0a0; background-color: #d0d0d0; }
        """
        
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(60, 30)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "spacing"))
        
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(60, 30)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "spacing"))
        
        spacing_layout.addWidget(copy_r_btn, copy_row, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(copy_l_btn, copy_row, 5, 1, 2, Qt.AlignCenter)
            
        layout.addWidget(spacing_group)
        
        # Run-out Group
        runout_group = QGroupBox("Run-out / Tooth thickness")
        runout_layout = QGridLayout(runout_group)
        runout_layout.setSpacing(5)
        runout_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        self.runout_btn_lim = QPushButton("Lim. upp.")
        self.runout_btn_qual = QPushButton("Quality")
        
        for btn in [self.runout_btn_lim, self.runout_btn_qual]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.runout_btn_lim.setChecked(True)
        self.runout_btn_qual.setChecked(False)
        
        # Connect signals
        self.runout_btn_lim.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "limits"))
        self.runout_btn_qual.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "quality"))
        
        runout_layout.addWidget(self.runout_btn_lim, 0, 2)
        runout_layout.addWidget(self.runout_btn_qual, 0, 3)
        
        rows_runout = [
            ("Run-out", "Fr"),
            ("Variation of tooth thickness", "Rs")
        ]
        
        for r, (label, code) in enumerate(rows_runout):
            row_idx = r + 1
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            runout_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp = QLineEdit("0.0")
            qual = QLineEdit("5")
            
            upp.setAlignment(Qt.AlignRight)
            qual.setAlignment(Qt.AlignCenter)
            
            runout_layout.addWidget(upp, row_idx, 2)
            runout_layout.addWidget(qual, row_idx, 3)
            
            self.spacing_inputs[code] = {"upp": upp, "qual": qual}
            
        layout.addWidget(runout_group)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
            
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize
        self.toggle_spacing_header_mode("left", "limits")
        self.toggle_spacing_header_mode("right", "limits")
        self.toggle_spacing_header_mode("runout", "limits")

    def create_ansi_b921_profile_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        # Using a gray color to match the MDI style
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800) # Set a reasonable fixed width or let it expand
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon (Blue diamond/logo placeholder)
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to ANSI B92.1 Profile"))
        title_layout.addStretch()
        
        # Window Controls
        # Minimize/Maximize buttons (Visual only)
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.profile_quality_spin = QSpinBox()
        self.quality_spins["ANSI B92.1_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 5480_Profile"] = self.profile_quality_spin
        self.quality_spins["ANSI B92.1_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 2013_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 1997_Profile"] = self.profile_quality_spin
        self.quality_spins["AGMA_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 3962_Profile"] = self.profile_quality_spin
        self.profile_quality_spin.setRange(1, 12)
        self.profile_quality_spin.setValue(5)
        self.profile_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.profile_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("profile"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Tooth Profile Icon
        icon_label = QLabel()
        # Use relative path for portability
        current_dir = os.path.dirname(os.path.abspath(__file__))
        icon_path = os.path.join(current_dir, "resources", "profile_tolerance_icon.png")
        
        try:
            from PyQt5.QtGui import QPixmap
            pixmap = QPixmap(icon_path)
            if not pixmap.isNull():
                # Increased size to 100x100 as requested
                icon_label.setPixmap(pixmap.scaled(100, 100, Qt.KeepAspectRatio, Qt.SmoothTransformation))
            else:
                # Fallback if image not found
                icon_label.setText("Profile")
                icon_label.setAlignment(Qt.AlignCenter)
                icon_label.setFixedSize(100, 100)
        except Exception as e:
            print(f"Error loading icon: {e}")
            icon_label.setText("Icon")
            icon_label.setFixedSize(100, 100)
            
        icon_label.setStyleSheet("background-color: white; border: 1px solid #ccc; padding: 5px;")
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        layout.addSpacing(10)
        
        # Main Table Frame
        table_frame = QFrame()
        table_frame.setFrameShape(QFrame.Box)
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        # Nom. val is a Label
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.btn_lim_upp_l = QPushButton("Lim. upp.")
        self.btn_lim_low_l = QPushButton("Lim. low.")
        self.btn_qual_l = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_l, self.btn_lim_low_l, self.btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_l.setChecked(True)
        self.btn_lim_low_l.setChecked(True)
        self.btn_qual_l.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_lim_low_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_qual_l.clicked.connect(lambda: self.toggle_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.btn_qual_l, 1, 6)
        
        # Right Side Headers
        # Nom. val is a Label
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.btn_lim_upp_r = QPushButton("Lim. upp.")
        self.btn_lim_low_r = QPushButton("Lim. low.")
        self.btn_qual_r = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_r, self.btn_lim_low_r, self.btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_r.setChecked(True)
        self.btn_lim_low_r.setChecked(True)
        self.btn_qual_r.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_lim_low_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_qual_r.clicked.connect(lambda: self.toggle_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.btn_qual_r, 1, 11)
        
        # Data Rows
        self.profile_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_Editable: True=QLineEdit, False=QLabel)
        # True = Visible, False = Hidden
        rows = [
            ("Angular error", "fHa", True, 
             [True, True, True, True], [True, True, True, True], False), # All visible, Nom not editable
            ("Variance Ang.err.", "Var", True, 
             [False, True, False, False], [False, True, False, False], False), # Nom, Low, Qual hidden
            ("Total error", "Fa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Form error", "ffa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Crowning", "Ca", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Tip-relief", "fKo", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Root-relief", "fFu", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Profile twist", "PV", True, 
             [True, True, True, False], [True, True, True, False], True)  # Qual hidden, Nom EDITABLE
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_editable) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.profile_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_l = QLineEdit("0.0")
                nom_l.setAlignment(Qt.AlignRight)
            else:
                nom_l = QLabel("0.0")
                nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_l = QLineEdit("0.0")
            low_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            low_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            
            if left_vis[0]: grid_layout.addWidget(nom_l, r, 3)
            else: nom_l.setVisible(False)
            
            if left_vis[1]: grid_layout.addWidget(upp_l, r, 4)
            else: upp_l.setVisible(False)
            
            if left_vis[2]: grid_layout.addWidget(low_l, r, 5)
            else: low_l.setVisible(False)
            
            if left_vis[3]: grid_layout.addWidget(qual_l, r, 6)
            else: qual_l.setVisible(False)
            
            # Right Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_r = QLineEdit("0.0")
                nom_r.setAlignment(Qt.AlignRight)
            else:
                nom_r = QLabel("0.0")
                nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_r = QLineEdit("0.0")
            low_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_r.setAlignment(Qt.AlignRight)
            low_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            if right_vis[0]: grid_layout.addWidget(nom_r, r, 8)
            else: nom_r.setVisible(False)
            
            if right_vis[1]: grid_layout.addWidget(upp_r, r, 9)
            else: upp_r.setVisible(False)
            
            if right_vis[2]: grid_layout.addWidget(low_r, r, 10)
            else: low_r.setVisible(False)
            
            if right_vis[3]: grid_layout.addWidget(qual_r, r, 11)
            else: qual_r.setVisible(False)
            
            # Store references
            self.profile_inputs[code] = {
                "left": {"nom": nom_l, "upp": upp_l, "low": low_l, "qual": qual_l},
                "right": {"nom": nom_r, "upp": upp_r, "low": low_r, "qual": qual_r}
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right) - under left section
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "profile"))
        
        # Left Copy Button (Right to Left) - under right section
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "profile"))
        
        # Add buttons to grid
        # Centered under the respective sections
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Under Left section? No, usually arrows point direction.
        # Ref image shows arrows at bottom.
        # Left arrow is under Right section pointing Left? Or under Left section?
        # Image 1 shows:
        # Left side has "Ba ->" (Left to Right?) No, wait.
        # Image 1 shows:
        # Under Left section: Arrow pointing RIGHT (Ba ->)
        # Under Right section: Arrow pointing LEFT (<- Ba)
        # Wait, usually "Ba ->" means Copy FROM Ba TO other?
        # Let's assume:
        # Button under Left section: Copy Left -> Right
        # Button under Right section: Copy Right -> Left
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Left side, arrow pointing right
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter) # Right side, arrow pointing left
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)

    def create_ansi_b921_lead_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN 3962 Lead"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.lead_quality_spin = QSpinBox()
        self.lead_quality_spin.setRange(1, 12)
        self.lead_quality_spin.setValue(5)
        self.lead_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.lead_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }""")
        set_btn.clicked.connect(lambda: self.calculate_tolerances("lead"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Add Lead Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "lead_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            # Scale to reasonable height if needed, e.g. 60px
            if pixmap.height() > 60:
                pixmap = pixmap.scaledToHeight(60, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Table Frame
        table_frame = QFrame()
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.lead_btn_lim_upp_l = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_l = QPushButton("Lim. low.")
        self.lead_btn_qual_l = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_l, self.lead_btn_lim_low_l, self.lead_btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_l.setChecked(True)
        self.lead_btn_lim_low_l.setChecked(True)
        self.lead_btn_qual_l.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_lim_low_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_qual_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.lead_btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.lead_btn_qual_l, 1, 6)
        
        # Right Side Headers
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.lead_btn_lim_upp_r = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_r = QPushButton("Lim. low.")
        self.lead_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_r, self.lead_btn_lim_low_r, self.lead_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_r.setChecked(True)
        self.lead_btn_lim_low_r.setChecked(True)
        self.lead_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_lim_low_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_qual_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.lead_btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.lead_btn_qual_r, 1, 11)
        
        # Data Rows
        self.lead_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_is_label: True=QLabel (no border), False=QLineEdit)
        rows = [
            ("Angular error", "fHb", True, [True, True, True, True], [True, True, True, True], True),
            ("Variance Ang.err.", "Var", True, [False, True, False, False], [False, True, False, False], False),
            ("Total error", "Fb", True, [False, True, False, True], [False, True, False, True], False),
            ("Form error", "ffb", True, [False, True, False, True], [False, True, False, True], False),
            ("Crowning", "Cb", True, [True, True, True, False], [True, True, True, False], True),
            ("Top-relief (lead)", "fo", True, [True, True, True, False], [True, True, True, False], True),
            ("Bottom-relief (lead)", "fu", True, [True, True, True, False], [True, True, True, False], True),
            ("Bending", "FV", True, [True, True, True, False], [True, True, True, False], False)
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_is_label) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.lead_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            left_widgets = {}
            
            if left_vis[0]: # Nom
                if nom_is_label:
                    nom_l = QLabel("0.0")
                    nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_l = QLineEdit("0.0")
                    nom_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_l, r, 3)
                left_widgets["nom"] = nom_l
            
            if left_vis[1]: # Upp
                upp_l = QLineEdit("0.0")
                upp_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_l, r, 4)
                left_widgets["upp"] = upp_l
                
            if left_vis[2]: # Low
                low_l = QLineEdit("0.0")
                low_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_l, r, 5)
                left_widgets["low"] = low_l
                
            if left_vis[3]: # Qual
                qual_l = QLineEdit("5")
                qual_l.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_l, r, 6)
                left_widgets["qual"] = qual_l
            
            # Right Side inputs
            right_widgets = {}
            
            if right_vis[0]: # Nom
                if nom_is_label:
                    nom_r = QLabel("0.0")
                    nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_r = QLineEdit("0.0")
                    nom_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_r, r, 8)
                right_widgets["nom"] = nom_r
                
            if right_vis[1]: # Upp
                upp_r = QLineEdit("0.0")
                upp_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_r, r, 9)
                right_widgets["upp"] = upp_r
                
            if right_vis[2]: # Low
                low_r = QLineEdit("0.0")
                low_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_r, r, 10)
                right_widgets["low"] = low_r
                
            if right_vis[3]: # Qual
                qual_r = QLineEdit("5")
                qual_r.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_r, r, 11)
                right_widgets["qual"] = qual_r
            
            # Store references
            self.lead_inputs[code] = {
                "left": left_widgets,
                "right": right_widgets
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right)
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "lead"))
        
        # Left Copy Button (Right to Left)
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "lead"))
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter)
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter)
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize field states
        self.toggle_lead_header_mode("left", "limits")
        self.toggle_lead_header_mode("right", "limits")

    def create_ansi_b921_spacing_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to ANSI B92.1 Spacing"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
            QGroupBox {
                border: 1px solid #808080;
                margin-top: 10px;
                font-weight: normal;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 3px;
                left: 10px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.spacing_quality_spin = QSpinBox()
        self.spacing_quality_spin.setRange(1, 12)
        self.spacing_quality_spin.setValue(5)
        self.spacing_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.spacing_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("spacing"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Spacing Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "spacing_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            if pixmap.height() > 80:
                pixmap = pixmap.scaledToHeight(80, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        else:
            # Placeholder if no icon
            icon_label.setText("Spacing")
            icon_label.setStyleSheet("border: 1px solid #ccc; background: white; padding: 5px;")
            icon_label.setFixedSize(80, 80)
            icon_label.setAlignment(Qt.AlignCenter)
            
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Spacing Group
        spacing_group = QGroupBox("Spacing")
        spacing_layout = QGridLayout(spacing_group)
        spacing_layout.setSpacing(5)
        spacing_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        spacing_layout.addWidget(QLabel("left"), 0, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(QLabel("right"), 0, 5, 1, 2, Qt.AlignCenter)
        
        # Add vertical separator
        sep = QFrame()
        sep.setFrameShape(QFrame.VLine)
        sep.setFrameShadow(QFrame.Sunken)
        sep.setStyleSheet("color: #808080;")
        spacing_layout.addWidget(sep, 0, 4, 7, 1) # Span down to cover rows
        
        # Buttons/Headers
        self.spacing_btn_lim_l = QPushButton("Lim. upp.")
        self.spacing_btn_qual_l = QPushButton("Quality")
        self.spacing_btn_lim_r = QPushButton("Lim. upp.")
        self.spacing_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.spacing_btn_lim_l, self.spacing_btn_qual_l, self.spacing_btn_lim_r, self.spacing_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.spacing_btn_lim_l.setChecked(True)
        self.spacing_btn_qual_l.setChecked(False)
        self.spacing_btn_lim_r.setChecked(True)
        self.spacing_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.spacing_btn_lim_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "limits"))
        self.spacing_btn_qual_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "quality"))
        self.spacing_btn_lim_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "limits"))
        self.spacing_btn_qual_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "quality"))
        
        spacing_layout.addWidget(self.spacing_btn_lim_l, 1, 2)
        spacing_layout.addWidget(self.spacing_btn_qual_l, 1, 3)
        spacing_layout.addWidget(self.spacing_btn_lim_r, 1, 5)
        spacing_layout.addWidget(self.spacing_btn_qual_r, 1, 6)
        
        self.spacing_inputs = {}
        rows = [
            ("Individual error", "fp"),
            ("Pitch jump", "fu"),
            ("Total error", "Fp"),
            ("Pitch-span var.", "Fpz/8")
        ]
        
        for r, (label, code) in enumerate(rows):
            row_idx = r + 2
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            spacing_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            upp_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            upp_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            spacing_layout.addWidget(upp_l, row_idx, 2)
            spacing_layout.addWidget(qual_l, row_idx, 3)
            spacing_layout.addWidget(upp_r, row_idx, 5)
            spacing_layout.addWidget(qual_r, row_idx, 6)
            
            self.spacing_inputs[code] = {
                "left": {"upp": upp_l, "qual": qual_l},
                "right": {"upp": upp_r, "qual": qual_r}
            }
            
        # Copy Buttons
        copy_row = len(rows) + 2
        
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover { background-color: #e0e0ff; }
            QPushButton:pressed { border: 2px inset #a0a0a0; background-color: #d0d0d0; }
        """
        
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(60, 30)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "spacing"))
        
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(60, 30)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "spacing"))
        
        spacing_layout.addWidget(copy_r_btn, copy_row, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(copy_l_btn, copy_row, 5, 1, 2, Qt.AlignCenter)
            
        layout.addWidget(spacing_group)
        
        # Run-out Group
        runout_group = QGroupBox("Run-out / Tooth thickness")
        runout_layout = QGridLayout(runout_group)
        runout_layout.setSpacing(5)
        runout_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        self.runout_btn_lim = QPushButton("Lim. upp.")
        self.runout_btn_qual = QPushButton("Quality")
        
        for btn in [self.runout_btn_lim, self.runout_btn_qual]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.runout_btn_lim.setChecked(True)
        self.runout_btn_qual.setChecked(False)
        
        # Connect signals
        self.runout_btn_lim.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "limits"))
        self.runout_btn_qual.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "quality"))
        
        runout_layout.addWidget(self.runout_btn_lim, 0, 2)
        runout_layout.addWidget(self.runout_btn_qual, 0, 3)
        
        rows_runout = [
            ("Run-out", "Fr"),
            ("Variation of tooth thickness", "Rs")
        ]
        
        for r, (label, code) in enumerate(rows_runout):
            row_idx = r + 1
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            runout_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp = QLineEdit("0.0")
            qual = QLineEdit("5")
            
            upp.setAlignment(Qt.AlignRight)
            qual.setAlignment(Qt.AlignCenter)
            
            runout_layout.addWidget(upp, row_idx, 2)
            runout_layout.addWidget(qual, row_idx, 3)
            
            self.spacing_inputs[code] = {"upp": upp, "qual": qual}
            
        layout.addWidget(runout_group)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
            
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize
        self.toggle_spacing_header_mode("left", "limits")
        self.toggle_spacing_header_mode("right", "limits")
        self.toggle_spacing_header_mode("runout", "limits")

    def create_din5480_profile_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        # Using a gray color to match the MDI style
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800) # Set a reasonable fixed width or let it expand
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon (Blue diamond/logo placeholder)
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN 5480 Profile"))
        title_layout.addStretch()
        
        # Window Controls
        # Minimize/Maximize buttons (Visual only)
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.profile_quality_spin = QSpinBox()
        self.quality_spins["DIN 5480_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 5480_Profile"] = self.profile_quality_spin
        self.quality_spins["ANSI B92.1_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 2013_Profile"] = self.profile_quality_spin
        self.quality_spins["ISO 1328 : 1997_Profile"] = self.profile_quality_spin
        self.quality_spins["AGMA_Profile"] = self.profile_quality_spin
        self.quality_spins["DIN 3962_Profile"] = self.profile_quality_spin
        self.profile_quality_spin.setRange(1, 12)
        self.profile_quality_spin.setValue(5)
        self.profile_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.profile_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("profile"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Tooth Profile Icon
        icon_label = QLabel()
        # Use relative path for portability
        current_dir = os.path.dirname(os.path.abspath(__file__))
        icon_path = os.path.join(current_dir, "resources", "profile_tolerance_icon.png")
        
        try:
            from PyQt5.QtGui import QPixmap
            pixmap = QPixmap(icon_path)
            if not pixmap.isNull():
                # Increased size to 100x100 as requested
                icon_label.setPixmap(pixmap.scaled(100, 100, Qt.KeepAspectRatio, Qt.SmoothTransformation))
            else:
                # Fallback if image not found
                icon_label.setText("Profile")
                icon_label.setAlignment(Qt.AlignCenter)
                icon_label.setFixedSize(100, 100)
        except Exception as e:
            print(f"Error loading icon: {e}")
            icon_label.setText("Icon")
            icon_label.setFixedSize(100, 100)
            
        icon_label.setStyleSheet("background-color: white; border: 1px solid #ccc; padding: 5px;")
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        layout.addSpacing(10)
        
        # Main Table Frame
        table_frame = QFrame()
        table_frame.setFrameShape(QFrame.Box)
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        # Nom. val is a Label
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.btn_lim_upp_l = QPushButton("Lim. upp.")
        self.btn_lim_low_l = QPushButton("Lim. low.")
        self.btn_qual_l = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_l, self.btn_lim_low_l, self.btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_l.setChecked(True)
        self.btn_lim_low_l.setChecked(True)
        self.btn_qual_l.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_lim_low_l.clicked.connect(lambda: self.toggle_header_mode("left", "limits"))
        self.btn_qual_l.clicked.connect(lambda: self.toggle_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.btn_qual_l, 1, 6)
        
        # Right Side Headers
        # Nom. val is a Label
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.btn_lim_upp_r = QPushButton("Lim. upp.")
        self.btn_lim_low_r = QPushButton("Lim. low.")
        self.btn_qual_r = QPushButton("Quality")
        
        for btn in [self.btn_lim_upp_r, self.btn_lim_low_r, self.btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.btn_lim_upp_r.setChecked(True)
        self.btn_lim_low_r.setChecked(True)
        self.btn_qual_r.setChecked(False)
        
        # Connect signals
        self.btn_lim_upp_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_lim_low_r.clicked.connect(lambda: self.toggle_header_mode("right", "limits"))
        self.btn_qual_r.clicked.connect(lambda: self.toggle_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.btn_qual_r, 1, 11)
        
        # Data Rows
        self.profile_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_Editable: True=QLineEdit, False=QLabel)
        # True = Visible, False = Hidden
        rows = [
            ("Angular error", "fHa", True, 
             [True, True, True, True], [True, True, True, True], False), # All visible, Nom not editable
            ("Variance Ang.err.", "Var", True, 
             [False, True, False, False], [False, True, False, False], False), # Nom, Low, Qual hidden
            ("Total error", "Fa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Form error", "ffa", True, 
             [False, True, False, True], [False, True, False, True], False), # Left: Nom, Low hidden; Right: Nom, Low hidden
            ("Crowning", "Ca", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Tip-relief", "fKo", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Root-relief", "fFu", False, 
             [True, True, True, False], [True, True, True, False], False), # Qual hidden, Nom not editable
            ("Profile twist", "PV", True, 
             [True, True, True, False], [True, True, True, False], True)  # Qual hidden, Nom EDITABLE
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_editable) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.profile_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_l = QLineEdit("0.0")
                nom_l.setAlignment(Qt.AlignRight)
            else:
                nom_l = QLabel("0.0")
                nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_l = QLineEdit("0.0")
            low_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            low_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            
            if left_vis[0]: grid_layout.addWidget(nom_l, r, 3)
            else: nom_l.setVisible(False)
            
            if left_vis[1]: grid_layout.addWidget(upp_l, r, 4)
            else: upp_l.setVisible(False)
            
            if left_vis[2]: grid_layout.addWidget(low_l, r, 5)
            else: low_l.setVisible(False)
            
            if left_vis[3]: grid_layout.addWidget(qual_l, r, 6)
            else: qual_l.setVisible(False)
            
            # Right Side inputs
            # Nom. val: editable or label based on flag
            if nom_editable:
                nom_r = QLineEdit("0.0")
                nom_r.setAlignment(Qt.AlignRight)
            else:
                nom_r = QLabel("0.0")
                nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
            
            upp_r = QLineEdit("0.0")
            low_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_r.setAlignment(Qt.AlignRight)
            low_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            if right_vis[0]: grid_layout.addWidget(nom_r, r, 8)
            else: nom_r.setVisible(False)
            
            if right_vis[1]: grid_layout.addWidget(upp_r, r, 9)
            else: upp_r.setVisible(False)
            
            if right_vis[2]: grid_layout.addWidget(low_r, r, 10)
            else: low_r.setVisible(False)
            
            if right_vis[3]: grid_layout.addWidget(qual_r, r, 11)
            else: qual_r.setVisible(False)
            
            # Store references
            self.profile_inputs[code] = {
                "left": {"nom": nom_l, "upp": upp_l, "low": low_l, "qual": qual_l},
                "right": {"nom": nom_r, "upp": upp_r, "low": low_r, "qual": qual_r}
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right) - under left section
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "profile"))
        
        # Left Copy Button (Right to Left) - under right section
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "profile"))
        
        # Add buttons to grid
        # Centered under the respective sections
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Under Left section? No, usually arrows point direction.
        # Ref image shows arrows at bottom.
        # Left arrow is under Right section pointing Left? Or under Left section?
        # Image 1 shows:
        # Left side has "Ba ->" (Left to Right?) No, wait.
        # Image 1 shows:
        # Under Left section: Arrow pointing RIGHT (Ba ->)
        # Under Right section: Arrow pointing LEFT (<- Ba)
        # Wait, usually "Ba ->" means Copy FROM Ba TO other?
        # Let's assume:
        # Button under Left section: Copy Left -> Right
        # Button under Right section: Copy Right -> Left
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter) # Left side, arrow pointing right
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter) # Right side, arrow pointing left
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)

    def create_din5480_lead_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN 3962 Lead"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.lead_quality_spin = QSpinBox()
        self.lead_quality_spin.setRange(1, 12)
        self.lead_quality_spin.setValue(5)
        self.lead_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.lead_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }""")
        set_btn.clicked.connect(lambda: self.calculate_tolerances("lead"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Add Lead Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "lead_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            # Scale to reasonable height if needed, e.g. 60px
            if pixmap.height() > 60:
                pixmap = pixmap.scaledToHeight(60, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Table Frame
        table_frame = QFrame()
        table_frame.setLineWidth(1)
        table_frame.setStyleSheet("QFrame { border: 1px solid #808080; background-color: white; }")
        table_layout = QVBoxLayout(table_frame)
        table_layout.setContentsMargins(5, 5, 5, 5)
        table_layout.setSpacing(0)
        
        # Create grid layout for table
        grid_widget = QWidget()
        grid_layout = QGridLayout(grid_widget)
        grid_layout.setSpacing(2)
        grid_layout.setContentsMargins(0, 0, 0, 0)
        
        # Headers - Top row with left/right
        left_label = QLabel("left")
        left_label.setAlignment(Qt.AlignCenter)
        left_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(left_label, 0, 3, 1, 4)
        
        right_label = QLabel("right")
        right_label.setAlignment(Qt.AlignCenter)
        right_label.setStyleSheet("font-weight: bold; padding: 3px;")
        grid_layout.addWidget(right_label, 0, 8, 1, 4)
        
        # Add vertical separator line between left and right
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        separator.setStyleSheet("color: #808080;")
        grid_layout.addWidget(separator, 0, 7, 11, 1)
        
        # Column headers
        output_header = QCheckBox("Output")
        output_header.setStyleSheet("font-weight: bold;")
        grid_layout.addWidget(output_header, 1, 0, 1, 2)
        
        # Left Side Headers
        lbl_nom_l = QLabel("Nom. val")
        lbl_nom_l.setAlignment(Qt.AlignCenter)
        lbl_nom_l.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_l, 1, 3)
        
        # Buttons for Left Side
        self.lead_btn_lim_upp_l = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_l = QPushButton("Lim. low.")
        self.lead_btn_qual_l = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_l, self.lead_btn_lim_low_l, self.lead_btn_qual_l]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_l.setChecked(True)
        self.lead_btn_lim_low_l.setChecked(True)
        self.lead_btn_qual_l.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_lim_low_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "limits"))
        self.lead_btn_qual_l.clicked.connect(lambda: self.toggle_lead_header_mode("left", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_l, 1, 4)
        grid_layout.addWidget(self.lead_btn_lim_low_l, 1, 5)
        grid_layout.addWidget(self.lead_btn_qual_l, 1, 6)
        
        # Right Side Headers
        lbl_nom_r = QLabel("Nom. val")
        lbl_nom_r.setAlignment(Qt.AlignCenter)
        lbl_nom_r.setStyleSheet("font-weight: bold; padding: 2px;")
        grid_layout.addWidget(lbl_nom_r, 1, 8)
        
        # Buttons for Right Side
        self.lead_btn_lim_upp_r = QPushButton("Lim. upp.")
        self.lead_btn_lim_low_r = QPushButton("Lim. low.")
        self.lead_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.lead_btn_lim_upp_r, self.lead_btn_lim_low_r, self.lead_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default state: Limits checked, Quality unchecked
        self.lead_btn_lim_upp_r.setChecked(True)
        self.lead_btn_lim_low_r.setChecked(True)
        self.lead_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.lead_btn_lim_upp_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_lim_low_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "limits"))
        self.lead_btn_qual_r.clicked.connect(lambda: self.toggle_lead_header_mode("right", "quality"))
        
        grid_layout.addWidget(self.lead_btn_lim_upp_r, 1, 9)
        grid_layout.addWidget(self.lead_btn_lim_low_r, 1, 10)
        grid_layout.addWidget(self.lead_btn_qual_r, 1, 11)
        
        # Data Rows
        self.lead_inputs = {}
        # Format: (Label, Code, Checked, 
        #          Left_Visibility[Nom, Upp, Low, Qual], 
        #          Right_Visibility[Nom, Upp, Low, Qual],
        #          Nom_is_label: True=QLabel (no border), False=QLineEdit)
        rows = [
            ("Angular error", "fHb", True, [True, True, True, True], [True, True, True, True], True),
            ("Variance Ang.err.", "Var", True, [False, True, False, False], [False, True, False, False], False),
            ("Total error", "Fb", True, [False, True, False, True], [False, True, False, True], False),
            ("Form error", "ffb", True, [False, True, False, True], [False, True, False, True], False),
            ("Crowning", "Cb", True, [True, True, True, False], [True, True, True, False], True),
            ("Top-relief (lead)", "fo", True, [True, True, True, False], [True, True, True, False], True),
            ("Bottom-relief (lead)", "fu", True, [True, True, True, False], [True, True, True, False], True),
            ("Bending", "FV", True, [True, True, True, False], [True, True, True, False], False)
        ]
        
        for row_idx, (label, code, checked, left_vis, right_vis, nom_is_label) in enumerate(rows):
            r = row_idx + 2
            
            # Checkbox with label
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(checked)
            grid_layout.addWidget(chk, r, 0, 1, 2)
            self.lead_inputs[f"{code}_check"] = chk
            
            # Left Side inputs
            left_widgets = {}
            
            if left_vis[0]: # Nom
                if nom_is_label:
                    nom_l = QLabel("0.0")
                    nom_l.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_l.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_l = QLineEdit("0.0")
                    nom_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_l, r, 3)
                left_widgets["nom"] = nom_l
            
            if left_vis[1]: # Upp
                upp_l = QLineEdit("0.0")
                upp_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_l, r, 4)
                left_widgets["upp"] = upp_l
                
            if left_vis[2]: # Low
                low_l = QLineEdit("0.0")
                low_l.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_l, r, 5)
                left_widgets["low"] = low_l
                
            if left_vis[3]: # Qual
                qual_l = QLineEdit("5")
                qual_l.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_l, r, 6)
                left_widgets["qual"] = qual_l
            
            # Right Side inputs
            right_widgets = {}
            
            if right_vis[0]: # Nom
                if nom_is_label:
                    nom_r = QLabel("0.0")
                    nom_r.setAlignment(Qt.AlignRight | Qt.AlignVCenter)
                    nom_r.setStyleSheet("border: none; background: transparent; padding: 2px;")
                else:
                    nom_r = QLineEdit("0.0")
                    nom_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(nom_r, r, 8)
                right_widgets["nom"] = nom_r
                
            if right_vis[1]: # Upp
                upp_r = QLineEdit("0.0")
                upp_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(upp_r, r, 9)
                right_widgets["upp"] = upp_r
                
            if right_vis[2]: # Low
                low_r = QLineEdit("0.0")
                low_r.setAlignment(Qt.AlignRight)
                grid_layout.addWidget(low_r, r, 10)
                right_widgets["low"] = low_r
                
            if right_vis[3]: # Qual
                qual_r = QLineEdit("5")
                qual_r.setAlignment(Qt.AlignCenter)
                grid_layout.addWidget(qual_r, r, 11)
                right_widgets["qual"] = qual_r
            
            # Store references
            self.lead_inputs[code] = {
                "left": left_widgets,
                "right": right_widgets
            }
        
        # Copy Buttons Row
        copy_row_idx = len(rows) + 2
        
        # Define unified button style
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover {
                background-color: #e0e0ff;
            }
            QPushButton:pressed {
                border: 2px inset #a0a0a0;
                background-color: #d0d0d0;
            }
        """
        
        # Right Copy Button (Left to Right)
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(80, 40)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.setToolTip("Copy from Left to Right")
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "lead"))
        
        # Left Copy Button (Right to Left)
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(80, 40)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.setToolTip("Copy from Right to Left")
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "lead"))
        
        grid_layout.addWidget(copy_r_btn, copy_row_idx, 3, 1, 4, Qt.AlignCenter)
        grid_layout.addWidget(copy_l_btn, copy_row_idx, 8, 1, 4, Qt.AlignCenter)
        
        table_layout.addWidget(grid_widget)
        layout.addWidget(table_frame)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
        
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize field states
        self.toggle_lead_header_mode("left", "limits")
        self.toggle_lead_header_mode("right", "limits")

    def create_din5480_spacing_page(self):
        page = QWidget()
        
        # 1. Background for the whole page (MDI background area)
        page.setStyleSheet("background-color: #A0A0A0;") 
        
        # Main layout for the page (to center the sub-window)
        page_layout = QVBoxLayout(page)
        page_layout.setContentsMargins(0, 0, 0, 0)
        
        # 2. The "Sub-Window" Container
        sub_window = QWidget()
        sub_window.setObjectName("sub_window")
        sub_window.setFixedWidth(800)
        sub_window.setStyleSheet("""
            QWidget#sub_window {
                background-color: #f0f0f0;
                border: 1px solid #404040;
                border-radius: 2px;
            }
        """)
        
        window_layout = QVBoxLayout(sub_window)
        window_layout.setContentsMargins(2, 2, 2, 2)
        window_layout.setSpacing(0)
        
        # 3. Title Bar
        title_bar = QFrame()
        title_bar.setFixedHeight(26)
        title_bar.setStyleSheet("""
            QFrame {
                background-color: qlineargradient(x1:0, y1:0, x2:0, y2:1, stop:0 #B9D1EA, stop:1 #87B3E0);
                border-bottom: 1px solid #a0a0a0;
            }
            QLabel {
                color: black;
                font-weight: bold;
                background: transparent;
                border: none;
                font-family: Arial;
                font-size: 9pt;
            }
        """)
        title_layout = QHBoxLayout(title_bar)
        title_layout.setContentsMargins(5, 0, 5, 0)
        title_layout.setSpacing(5)
        
        # Icon
        icon_lbl = QLabel("ðŸ”¹") 
        icon_lbl.setStyleSheet("color: #000080; font-size: 10pt;")
        title_layout.addWidget(icon_lbl)
        
        title_layout.addWidget(QLabel("Tolerances acc.to DIN 5480 Spacing"))
        title_layout.addStretch()
        
        # Window Controls
        min_btn = QToolButton()
        min_btn.setText("â”€")
        min_btn.setFixedSize(20, 18)
        min_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
                padding-bottom: 5px;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        max_btn = QToolButton()
        max_btn.setText("â–¡")
        max_btn.setFixedSize(20, 18)
        max_btn.setStyleSheet("""
            QToolButton {
                background: transparent;
                border: 1px solid #808080;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #d0d0ff; }
        """)
        
        close_btn = QToolButton()
        close_btn.setText("âœ•")
        close_btn.setFixedSize(20, 18)
        close_btn.setStyleSheet("""
            QToolButton {
                background-color: #cc5555; 
                color: white; 
                font-weight: bold; 
                border: 1px solid #800000;
                border-radius: 2px;
                font-size: 8pt;
            }
            QToolButton:hover { background-color: #ff6666; }
        """)
        
        title_layout.addWidget(min_btn)
        title_layout.addWidget(max_btn)
        title_layout.addWidget(close_btn)
        
        window_layout.addWidget(title_bar)
        
        # 4. Content Area
        content_widget = QWidget()
        content_widget.setStyleSheet("""
            QWidget {
                background-color: #f0f0f0;
                font-family: Arial;
                font-size: 9pt;
            }
            QLineEdit {
                background-color: white;
                border: 1px solid #a0a0a0;
                padding: 2px;
                min-width: 50px;
            }
            QCheckBox {
                spacing: 5px;
            }
            QGroupBox {
                border: 1px solid #808080;
                margin-top: 10px;
                font-weight: normal;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                subcontrol-position: top left;
                padding: 0 3px;
                left: 10px;
            }
        """)
        
        layout = QVBoxLayout(content_widget)
        layout.setContentsMargins(15, 15, 15, 15)
        
        # Header: Quality Level
        header_layout = QHBoxLayout()
        header_layout.addWidget(QLabel("Quality levels Q ="))
        self.spacing_quality_spin = QSpinBox()
        self.spacing_quality_spin.setRange(1, 12)
        self.spacing_quality_spin.setValue(5)
        self.spacing_quality_spin.setFixedWidth(50)
        header_layout.addWidget(self.spacing_quality_spin)
        
        set_btn = QPushButton("Set")
        set_btn.setStyleSheet("""
            QPushButton {
                background-color: #ffff00;
                border: 1px solid #808080;
                padding: 3px 15px;
                font-weight: bold;
            }
            QPushButton:hover {
                background-color: #ffff80;
            }
        """)
        set_btn.clicked.connect(lambda: self.calculate_tolerances("spacing"))
        header_layout.addWidget(set_btn)
        header_layout.addStretch()
        
        # Spacing Icon
        icon_label = QLabel()
        icon_path = os.path.join(os.path.dirname(__file__), "resources", "spacing_tolerance_icon.png")
        if os.path.exists(icon_path):
            pixmap = QPixmap(icon_path)
            if pixmap.height() > 80:
                pixmap = pixmap.scaledToHeight(80, Qt.SmoothTransformation)
            icon_label.setPixmap(pixmap)
        else:
            # Placeholder if no icon
            icon_label.setText("Spacing")
            icon_label.setStyleSheet("border: 1px solid #ccc; background: white; padding: 5px;")
            icon_label.setFixedSize(80, 80)
            icon_label.setAlignment(Qt.AlignCenter)
            
        header_layout.addWidget(icon_label)
        
        layout.addLayout(header_layout)
        
        # Spacing Group
        spacing_group = QGroupBox("Spacing")
        spacing_layout = QGridLayout(spacing_group)
        spacing_layout.setSpacing(5)
        spacing_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        spacing_layout.addWidget(QLabel("left"), 0, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(QLabel("right"), 0, 5, 1, 2, Qt.AlignCenter)
        
        # Add vertical separator
        sep = QFrame()
        sep.setFrameShape(QFrame.VLine)
        sep.setFrameShadow(QFrame.Sunken)
        sep.setStyleSheet("color: #808080;")
        spacing_layout.addWidget(sep, 0, 4, 7, 1) # Span down to cover rows
        
        # Buttons/Headers
        self.spacing_btn_lim_l = QPushButton("Lim. upp.")
        self.spacing_btn_qual_l = QPushButton("Quality")
        self.spacing_btn_lim_r = QPushButton("Lim. upp.")
        self.spacing_btn_qual_r = QPushButton("Quality")
        
        for btn in [self.spacing_btn_lim_l, self.spacing_btn_qual_l, self.spacing_btn_lim_r, self.spacing_btn_qual_r]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.spacing_btn_lim_l.setChecked(True)
        self.spacing_btn_qual_l.setChecked(False)
        self.spacing_btn_lim_r.setChecked(True)
        self.spacing_btn_qual_r.setChecked(False)
        
        # Connect signals
        self.spacing_btn_lim_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "limits"))
        self.spacing_btn_qual_l.clicked.connect(lambda: self.toggle_spacing_header_mode("left", "quality"))
        self.spacing_btn_lim_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "limits"))
        self.spacing_btn_qual_r.clicked.connect(lambda: self.toggle_spacing_header_mode("right", "quality"))
        
        spacing_layout.addWidget(self.spacing_btn_lim_l, 1, 2)
        spacing_layout.addWidget(self.spacing_btn_qual_l, 1, 3)
        spacing_layout.addWidget(self.spacing_btn_lim_r, 1, 5)
        spacing_layout.addWidget(self.spacing_btn_qual_r, 1, 6)
        
        self.spacing_inputs = {}
        rows = [
            ("Individual error", "fp"),
            ("Pitch jump", "fu"),
            ("Total error", "Fp"),
            ("Pitch-span var.", "Fpz/8")
        ]
        
        for r, (label, code) in enumerate(rows):
            row_idx = r + 2
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            spacing_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp_l = QLineEdit("0.0")
            qual_l = QLineEdit("5")
            upp_r = QLineEdit("0.0")
            qual_r = QLineEdit("5")
            
            upp_l.setAlignment(Qt.AlignRight)
            qual_l.setAlignment(Qt.AlignCenter)
            upp_r.setAlignment(Qt.AlignRight)
            qual_r.setAlignment(Qt.AlignCenter)
            
            spacing_layout.addWidget(upp_l, row_idx, 2)
            spacing_layout.addWidget(qual_l, row_idx, 3)
            spacing_layout.addWidget(upp_r, row_idx, 5)
            spacing_layout.addWidget(qual_r, row_idx, 6)
            
            self.spacing_inputs[code] = {
                "left": {"upp": upp_l, "qual": qual_l},
                "right": {"upp": upp_r, "qual": qual_r}
            }
            
        # Copy Buttons
        copy_row = len(rows) + 2
        
        button_style = """
            QPushButton {
                border: 2px outset #a0a0a0;
                background-color: #f0f0f0;
                border-radius: 3px;
                font-size: 10pt;
                padding: 5px;
            }
            QPushButton:hover { background-color: #e0e0ff; }
            QPushButton:pressed { border: 2px inset #a0a0a0; background-color: #d0d0d0; }
        """
        
        copy_r_btn = QPushButton("â†’")
        copy_r_btn.setFixedSize(60, 30)
        copy_r_btn.setStyleSheet(button_style)
        copy_r_btn.clicked.connect(lambda: self.copy_tolerances("left_to_right", "spacing"))
        
        copy_l_btn = QPushButton("â†")
        copy_l_btn.setFixedSize(60, 30)
        copy_l_btn.setStyleSheet(button_style)
        copy_l_btn.clicked.connect(lambda: self.copy_tolerances("right_to_left", "spacing"))
        
        spacing_layout.addWidget(copy_r_btn, copy_row, 2, 1, 2, Qt.AlignCenter)
        spacing_layout.addWidget(copy_l_btn, copy_row, 5, 1, 2, Qt.AlignCenter)
            
        layout.addWidget(spacing_group)
        
        # Run-out Group
        runout_group = QGroupBox("Run-out / Tooth thickness")
        runout_layout = QGridLayout(runout_group)
        runout_layout.setSpacing(5)
        runout_layout.setContentsMargins(10, 15, 10, 10)
        
        # Headers
        self.runout_btn_lim = QPushButton("Lim. upp.")
        self.runout_btn_qual = QPushButton("Quality")
        
        for btn in [self.runout_btn_lim, self.runout_btn_qual]:
            btn.setCheckable(True)
            btn.setFixedHeight(24)
            
        # Default states
        self.runout_btn_lim.setChecked(True)
        self.runout_btn_qual.setChecked(False)
        
        # Connect signals
        self.runout_btn_lim.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "limits"))
        self.runout_btn_qual.clicked.connect(lambda: self.toggle_spacing_header_mode("runout", "quality"))
        
        runout_layout.addWidget(self.runout_btn_lim, 0, 2)
        runout_layout.addWidget(self.runout_btn_qual, 0, 3)
        
        rows_runout = [
            ("Run-out", "Fr"),
            ("Variation of tooth thickness", "Rs")
        ]
        
        for r, (label, code) in enumerate(rows_runout):
            row_idx = r + 1
            chk = QCheckBox(f"{label}   {code}")
            chk.setChecked(True)
            runout_layout.addWidget(chk, row_idx, 0, 1, 2)
            self.spacing_inputs[f"{code}_check"] = chk
            
            upp = QLineEdit("0.0")
            qual = QLineEdit("5")
            
            upp.setAlignment(Qt.AlignRight)
            qual.setAlignment(Qt.AlignCenter)
            
            runout_layout.addWidget(upp, row_idx, 2)
            runout_layout.addWidget(qual, row_idx, 3)
            
            self.spacing_inputs[code] = {"upp": upp, "qual": qual}
            
        layout.addWidget(runout_group)
        
        # Footer
        footer_layout = QHBoxLayout()
        footer_layout.addWidget(QLabel("Tolerances in Î¼m"))
        footer_layout.addStretch()
        layout.addLayout(footer_layout)
        
        layout.addSpacing(10)
        
        # Buttons
        btn_layout = QHBoxLayout()
        btn_layout.addStretch()
        
        return_btn = QPushButton("Return")
        return_btn.setFixedWidth(80)
        btn_layout.addWidget(return_btn)
        
        continue_btn = QPushButton("Continue")
        continue_btn.setFixedWidth(80)
        btn_layout.addWidget(continue_btn)
            
        ok_btn = QPushButton("Ok")
        ok_btn.setFixedWidth(80)
        ok_btn.clicked.connect(self.accept)
        btn_layout.addWidget(ok_btn)
        
        cancel_btn = QPushButton("Cancel")
        cancel_btn.setFixedWidth(80)
        cancel_btn.clicked.connect(self.reject)
        btn_layout.addWidget(cancel_btn)
        
        apply_btn = QPushButton("Apply")
        apply_btn.setFixedWidth(80)
        apply_btn.clicked.connect(self.apply_settings)
        btn_layout.addWidget(apply_btn)
        
        btn_layout.addStretch()
        layout.addLayout(btn_layout)
        
        # Add content widget to window layout
        window_layout.addWidget(content_widget)
        
        # Add sub-window to page layout with centering
        page_layout.addStretch()
        page_layout.addWidget(sub_window, 0, Qt.AlignCenter)
        page_layout.addStretch()
        
        self.content_stack.addWidget(page)
        
        # Initialize
        self.toggle_spacing_header_mode("left", "limits")
        self.toggle_spacing_header_mode("right", "limits")
        self.toggle_spacing_header_mode("runout", "limits")

    def create_empty_page(self):
        page = QWidget()
        layout = QVBoxLayout(page)
        layout.addWidget(QLabel("Not implemented yet"))
        self.content_stack.addWidget(page)

    def load_initial_data(self):
        # Load data from self.gear_data if available
        # This is where we would populate the fields if we had saved data
        pass

    def calculate_tolerances(self, type_):
        """Set tolerance values based on quality level using predefined lookup tables"""
        try:
            if type_ == "profile":
                # Get the correct quality spin box based on current page
                if self.current_page_id and self.current_page_id in self.quality_spins:
                    quality_spin = self.quality_spins[self.current_page_id]
                    Q = quality_spin.value()
                else:
                    # Fallback if no current page info
                    Q = 5
                
                # Fixed tolerance values for each quality level (from reference images)
                # Quality level: (fHa, ffa, Fa)
                tolerance_table = {
                    1: (3.0, 4.0, 5.0),
                    2: (4.0, 6.0, 7.0),
                    3: (5.5, 8.0, 10.0),
                    4: (8.0, 12.0, 14.0),
                    5: (11.0, 16.0, 20.0),
                    6: (16.0, 22.0, 28.0),
                    7: (22.0, 32.0, 40.0),
                    8: (28.0, 45.0, 56.0),
                    9: (40.0, 63.0, 80.0),
                    10: (71.0, 110.0, 125.0),
                    11: (110.0, 160.0, 200.0),
                    12: (180.0, 250.0, 320.0)
                }
                
                # Get tolerance values for the selected quality level
                if Q in tolerance_table:
                    fHa, ffa, Fa = tolerance_table[Q]
                else:
                    # Default to quality level 5 if out of range
                    fHa, ffa, Fa = tolerance_table[5]
                
                # Update UI - set all quality fields to the selected quality level
                for side in ['left', 'right']:
                    # Update all quality fields to show the selected quality level
                    for code in self.profile_inputs:
                        if "_check" not in code and side in self.profile_inputs[code]:
                            if 'qual' in self.profile_inputs[code][side]:
                                qual_field = self.profile_inputs[code][side]['qual']
                                if isinstance(qual_field, QLineEdit):
                                    qual_field.setText(str(Q))
                    
                    # Update tolerance values with fixed values from lookup table
                    self.profile_inputs['fHa'][side]['upp'].setText(f"{fHa:.1f}")
                    self.profile_inputs['fHa'][side]['low'].setText(f"{-fHa:.1f}")
                    
                    self.profile_inputs['ffa'][side]['upp'].setText(f"{ffa:.1f}")
                    
                    self.profile_inputs['Fa'][side]['upp'].setText(f"{Fa:.1f}")
                    
                    # Var doesn't have quality field in the visible columns, set to 0.0
                    if 'Var' in self.profile_inputs:
                        self.profile_inputs['Var'][side]['upp'].setText("0.0")

            elif type_ == "lead":
                Q = self.lead_quality_spin.value()
                
                # Fixed tolerance values for Lead (fHb, ffb, Fb) based on user images
                # Quality level: (fHb, ffb, Fb)
                lead_tolerance_table = {
                    1: (2.5, 2.0, 3.0),
                    2: (3.5, 5.0, 6.0),
                    3: (4.5, 7.0, 8.0),
                    4: (6.0, 8.0, 10.0),
                    5: (8.0, 9.0, 12.0),
                    6: (11.0, 12.0, 16.0),
                    7: (16.0, 16.0, 22.0),
                    8: (22.0, 25.0, 32.0),
                    9: (32.0, 40.0, 50.0),
                    10: (50.0, 63.0, 80.0),
                    11: (80.0, 100.0, 125.0),
                    12: (125.0, 160.0, 200.0)
                }
                
                if Q in lead_tolerance_table:
                    fHb, ffb, Fb = lead_tolerance_table[Q]
                else:
                    # Fallback to calculation for other levels
                    width = float(self.gear_data.get('width', 0) or 0)
                    factor = 2 ** (0.5 * (Q - 5))
                    
                    # Approximations
                    if width > 0:
                        fHb = (0.3 * width**0.5 + 4.0) * factor 
                    else:
                        fHb = 10.0 * factor
    
                    ffb = fHb * 0.8
                    Fb = fHb * 1.2
                
                for side in ['left', 'right']:
                    # Update ALL quality fields
                    for code in self.lead_inputs:
                        if "_check" not in code and side in self.lead_inputs[code]:
                            if 'qual' in self.lead_inputs[code][side]:
                                self.lead_inputs[code][side]['qual'].setText(str(Q))

                    # Update calculated tolerances
                    self.lead_inputs['fHb'][side]['upp'].setText(f"{fHb:.1f}")
                    self.lead_inputs['fHb'][side]['low'].setText(f"{-fHb:.1f}")
                    
                    self.lead_inputs['ffb'][side]['upp'].setText(f"{ffb:.1f}")
                    
                    self.lead_inputs['Fb'][side]['upp'].setText(f"{Fb:.1f}")

            elif type_ == "spacing":
                Q = self.spacing_quality_spin.value()
                
                # Tolerance values from user images for Q=1 to Q=12
                # Format: (fp, fu, Fp, Fpz/8, Fr, Rs)
                spacing_lookup = {
                    1: (3.0, 4.0, 9.0, 6.0, 7.0, 4.5),
                    2: (4.5, 5.5, 14.0, 8.0, 10.0, 7.0),
                    3: (6.0, 8.0, 18.0, 11.0, 14.0, 9.0),
                    4: (8.0, 10.0, 25.0, 16.0, 20.0, 12.0),
                    5: (12.0, 16.0, 36.0, 22.0, 28.0, 18.0),
                    6: (16.0, 20.0, 45.0, 32.0, 40.0, 25.0),
                    7: (22.0, 28.0, 71.0, 40.0, 56.0, 36.0),
                    8: (32.0, 40.0, 90.0, 63.0, 80.0, 50.0),
                    9: (45.0, 56.0, 125.0, 80.0, 110.0, 71.0),
                    10: (71.0, 90.0, 200.0, 140.0, 160.0, 100.0),
                    11: (110.0, 140.0, 320.0, 220.0, 220.0, 140.0),
                    12: (180.0, 220.0, 560.0, 320.0, 320.0, 180.0)
                }
                
                if Q in spacing_lookup:
                    fp, fu, Fp, Fpz8, Fr, Rs = spacing_lookup[Q]
                else:
                    # For Q > 12, extrapolate from Q=12 values using ISO factor
                    # factor = 2^(0.5 * (Q - 12))
                    base_values = spacing_lookup[12]
                    factor = 2 ** (0.5 * (Q - 12))
                    
                    fp = base_values[0] * factor
                    fu = base_values[1] * factor
                    Fp = base_values[2] * factor
                    Fpz8 = base_values[3] * factor
                    Fr = base_values[4] * factor
                    Rs = base_values[5] * factor
                
                # Update Spacing Group (Left/Right)
                for side in ['left', 'right']:
                    # Update Quality fields
                    for code in ['fp', 'fu', 'Fp', 'Fpz/8']:
                        if code in self.spacing_inputs and side in self.spacing_inputs[code]:
                            if 'qual' in self.spacing_inputs[code][side]:
                                self.spacing_inputs[code][side]['qual'].setText(str(Q))
                            
                    # Update Values
                    if 'fp' in self.spacing_inputs and side in self.spacing_inputs['fp']:
                        self.spacing_inputs['fp'][side]['upp'].setText(f"{fp:.1f}")
                    if 'fu' in self.spacing_inputs and side in self.spacing_inputs['fu']:
                        self.spacing_inputs['fu'][side]['upp'].setText(f"{fu:.1f}")
                    if 'Fp' in self.spacing_inputs and side in self.spacing_inputs['Fp']:
                        self.spacing_inputs['Fp'][side]['upp'].setText(f"{Fp:.1f}")
                    if 'Fpz/8' in self.spacing_inputs and side in self.spacing_inputs['Fpz/8']:
                        self.spacing_inputs['Fpz/8'][side]['upp'].setText(f"{Fpz8:.1f}")
                    
                # Update Run-out Group (Single)
                # Fr
                if 'Fr' in self.spacing_inputs:
                    if 'qual' in self.spacing_inputs['Fr']: self.spacing_inputs['Fr']['qual'].setText(str(Q))
                    if 'upp' in self.spacing_inputs['Fr']: self.spacing_inputs['Fr']['upp'].setText(f"{Fr:.1f}")
                    
                # Rs
                if 'Rs' in self.spacing_inputs:
                    if 'qual' in self.spacing_inputs['Rs']: self.spacing_inputs['Rs']['qual'].setText(str(Q))
                    if 'upp' in self.spacing_inputs['Rs']: self.spacing_inputs['Rs']['upp'].setText(f"{Rs:.1f}")
                    
        except Exception as e:
            QMessageBox.warning(self, "Error", f"Calculation failed: {e}")

    def toggle_header_mode(self, side, mode):
        """
        Toggle header buttons state and enable/disable corresponding fields.
        side: "left" or "right"
        mode: "limits" (Lim. upp./low.) or "quality" (Quality)
        
        When limits mode: enable limit fields, disable quality fields (gray them out)
        When quality mode: enable quality fields, disable limit fields (gray them out)
        """
        # Update button states
        if side == "left":
            if mode == "limits":
                self.btn_lim_upp_l.setChecked(True)
                self.btn_lim_low_l.setChecked(True)
                self.btn_qual_l.setChecked(False)
            else:
                self.btn_lim_upp_l.setChecked(False)
                self.btn_lim_low_l.setChecked(False)
                self.btn_qual_l.setChecked(True)
        else: # right
            if mode == "limits":
                self.btn_lim_upp_r.setChecked(True)
                self.btn_lim_low_r.setChecked(True)
                self.btn_qual_r.setChecked(False)
            else:
                self.btn_lim_upp_r.setChecked(False)
                self.btn_lim_low_r.setChecked(False)
                self.btn_qual_r.setChecked(True)
        
        # Update field states for profile inputs
        if hasattr(self, 'profile_inputs'):
            for code, inputs in self.profile_inputs.items():
                if "_check" in code:
                    continue
                
                if side not in inputs:
                    continue
                
                side_inputs = inputs[side]
                
                if mode == "limits":
                    # Enable limit fields, disable quality fields
                    for field_name in ['upp', 'low']:
                        if field_name in side_inputs:
                            field = side_inputs[field_name]
                            if isinstance(field, QLineEdit):
                                field.setEnabled(True)
                                field.setStyleSheet("")
                    
                    if 'qual' in side_inputs:
                        qual_field = side_inputs['qual']
                        if isinstance(qual_field, QLineEdit):
                            qual_field.setEnabled(False)
                            qual_field.setStyleSheet("background-color: #e0e0e0; color: #808080;")
                else:  # quality mode
                    # Disable limit fields, enable quality fields
                    for field_name in ['upp', 'low']:
                        if field_name in side_inputs:
                            field = side_inputs[field_name]
                            if isinstance(field, QLineEdit):
                                field.setEnabled(False)
                                field.setStyleSheet("background-color: #e0e0e0; color: #808080;")
                    
                    if 'qual' in side_inputs:
                        qual_field = side_inputs['qual']
                        if isinstance(qual_field, QLineEdit):
                            qual_field.setEnabled(True)
                            qual_field.setStyleSheet("")

    def toggle_lead_header_mode(self, side, mode):
        """
        Toggle header buttons state and enable/disable corresponding fields for LEAD page.
        side: "left" or "right"
        mode: "limits" (Lim. upp./low.) or "quality" (Quality)
        """
        # Update button states
        if side == "left":
            if mode == "limits":
                self.lead_btn_lim_upp_l.setChecked(True)
                self.lead_btn_lim_low_l.setChecked(True)
                self.lead_btn_qual_l.setChecked(False)
            else:
                self.lead_btn_lim_upp_l.setChecked(False)
                self.lead_btn_lim_low_l.setChecked(False)
                self.lead_btn_qual_l.setChecked(True)
        else: # right
            if mode == "limits":
                self.lead_btn_lim_upp_r.setChecked(True)
                self.lead_btn_lim_low_r.setChecked(True)
                self.lead_btn_qual_r.setChecked(False)
            else:
                self.lead_btn_lim_upp_r.setChecked(False)
                self.lead_btn_lim_low_r.setChecked(False)
                self.lead_btn_qual_r.setChecked(True)
        
        # Update field states for lead inputs
        if hasattr(self, 'lead_inputs'):
            for code, inputs in self.lead_inputs.items():
                if "_check" in code:
                    continue
                
                if side not in inputs:
                    continue
                
                side_inputs = inputs[side]
                
                if mode == "limits":
                    # Enable limit fields, disable quality fields
                    for field_name in ['upp', 'low']:
                        if field_name in side_inputs:
                            field = side_inputs[field_name]
                            if isinstance(field, QLineEdit):
                                field.setEnabled(True)
                                field.setStyleSheet("")
                    
                    if 'qual' in side_inputs:
                        qual_field = side_inputs['qual']
                        if isinstance(qual_field, QLineEdit):
                            qual_field.setEnabled(False)
                            qual_field.setStyleSheet("background-color: #e0e0e0; color: #808080;")
                else:  # quality mode
                    # Disable limit fields, enable quality fields
                    for field_name in ['upp', 'low']:
                        if field_name in side_inputs:
                            field = side_inputs[field_name]
                            if isinstance(field, QLineEdit):
                                field.setEnabled(False)
                                field.setStyleSheet("background-color: #e0e0e0; color: #808080;")
                    
                    if 'qual' in side_inputs:
                        qual_field = side_inputs['qual']
                        if isinstance(qual_field, QLineEdit):
                            qual_field.setEnabled(True)
                            qual_field.setStyleSheet("")

    def toggle_spacing_header_mode(self, side, mode):
        """
        Toggle header buttons state and enable/disable corresponding fields for SPACING page.
        side: "left", "right", or "runout"
        mode: "limits" (Lim. upp.) or "quality" (Quality)
        """
        # Update button states
        if side == "left":
            if mode == "limits":
                self.spacing_btn_lim_l.setChecked(True)
                self.spacing_btn_qual_l.setChecked(False)
            else:
                self.spacing_btn_lim_l.setChecked(False)
                self.spacing_btn_qual_l.setChecked(True)
        elif side == "right":
            if mode == "limits":
                self.spacing_btn_lim_r.setChecked(True)
                self.spacing_btn_qual_r.setChecked(False)
            else:
                self.spacing_btn_lim_r.setChecked(False)
                self.spacing_btn_qual_r.setChecked(True)
        elif side == "runout":
            if mode == "limits":
                self.runout_btn_lim.setChecked(True)
                self.runout_btn_qual.setChecked(False)
            else:
                self.runout_btn_lim.setChecked(False)
                self.runout_btn_qual.setChecked(True)
        
        # Update field states
        if hasattr(self, 'spacing_inputs'):
            for code, inputs in self.spacing_inputs.items():
                if "_check" in code: continue
                
                # Determine which inputs to update
                target_inputs = None
                
                if side in ["left", "right"]:
                    # Spacing items have left/right structure
                    if side in inputs:
                        target_inputs = inputs[side]
                elif side == "runout":
                    # Runout items are flat structure (no left/right keys)
                    # But we need to distinguish runout items from spacing items
                    # Spacing items have 'left'/'right' keys. Runout items have 'upp'/'qual' directly.
                    if "left" not in inputs and "right" not in inputs:
                        target_inputs = inputs
                
                if target_inputs:
                    if mode == "limits":
                        # Enable limit fields, disable quality fields
                        if 'upp' in target_inputs:
                            field = target_inputs['upp']
                            if isinstance(field, QLineEdit):
                                field.setEnabled(True)
                                field.setStyleSheet("")
                        
                        if 'qual' in target_inputs:
                            field = target_inputs['qual']
                            if isinstance(field, QLineEdit):
                                field.setEnabled(False)
                                field.setStyleSheet("background-color: #e0e0e0; color: #808080;")
                    else: # quality mode
                        # Disable limit fields, enable quality fields
                        if 'upp' in target_inputs:
                            field = target_inputs['upp']
                            if isinstance(field, QLineEdit):
                                field.setEnabled(False)
                                field.setStyleSheet("background-color: #e0e0e0; color: #808080;")
                        
                        if 'qual' in target_inputs:
                            field = target_inputs['qual']
                            if isinstance(field, QLineEdit):
                                field.setEnabled(True)
                                field.setStyleSheet("")

    def copy_tolerances(self, direction, type_):
        """
        Copy tolerance values between left and right sides.
        direction: "left_to_right" or "right_to_left"
        type_: "profile", "lead", "spacing"
        """
        try:
            inputs_map = {}
            if type_ == "profile":
                inputs_map = self.profile_inputs
            elif type_ == "lead":
                inputs_map = self.lead_inputs
            elif type_ == "spacing":
                inputs_map = self.spacing_inputs
            
            for code, inputs in inputs_map.items():
                if "_check" in code: continue
                
                # Skip if not structured as left/right (e.g. some spacing items)
                if "left" not in inputs or "right" not in inputs:
                    continue
                    
                src = inputs["left"] if direction == "left_to_right" else inputs["right"]
                dst = inputs["right"] if direction == "left_to_right" else inputs["left"]
                
                # Copy values if widgets exist and are visible
                if "nom" in src and "nom" in dst and src["nom"].isVisible() and dst["nom"].isVisible():
                    # nom is now a QLabel, use setText for both
                    dst["nom"].setText(src["nom"].text())
                    
                if "upp" in src and "upp" in dst and src["upp"].isVisible() and dst["upp"].isVisible():
                    dst["upp"].setText(src["upp"].text())
                    
                if "low" in src and "low" in dst and src["low"].isVisible() and dst["low"].isVisible():
                    dst["low"].setText(src["low"].text())
                    
                if "qual" in src and "qual" in dst and src["qual"].isVisible() and dst["qual"].isVisible():
                    dst["qual"].setText(src["qual"].text())
                    
        except Exception as e:
            print(f"Error copying tolerances: {e}")

    def apply_settings(self):
        """Collect data and emit signal"""
        settings = {
            "profile": {},
            "lead": {},
            "spacing": {}
        }
        
        def get_text(widget):
            if isinstance(widget, QLineEdit) or isinstance(widget, QLabel):
                return widget.text()
            return "0"
        
        # Collect Profile
        for code, inputs in self.profile_inputs.items():
            if "_check" in code: continue
            settings["profile"][code] = {
                "left": {
                    "nom": float(get_text(inputs["left"].get("nom")) or 0),
                    "upp": float(get_text(inputs["left"].get("upp")) or 0),
                    "low": float(get_text(inputs["left"].get("low")) or 0),
                    "qual": int(get_text(inputs["left"].get("qual")) or 0)
                },
                "right": {
                    "nom": float(get_text(inputs["right"].get("nom")) or 0),
                    "upp": float(get_text(inputs["right"].get("upp")) or 0),
                    "low": float(get_text(inputs["right"].get("low")) or 0),
                    "qual": int(get_text(inputs["right"].get("qual")) or 0)
                }
            }
            
        # Collect Lead
        for code, inputs in self.lead_inputs.items():
            if "_check" in code: continue
            settings["lead"][code] = {
                "left": {
                    "nom": float(get_text(inputs["left"].get("nom")) or 0),
                    "upp": float(get_text(inputs["left"].get("upp")) or 0),
                    "low": float(get_text(inputs["left"].get("low")) or 0),
                    "qual": int(get_text(inputs["left"].get("qual")) or 0)
                },
                "right": {
                    "nom": float(get_text(inputs["right"].get("nom")) or 0),
                    "upp": float(get_text(inputs["right"].get("upp")) or 0),
                    "low": float(get_text(inputs["right"].get("low")) or 0),
                    "qual": int(get_text(inputs["right"].get("qual")) or 0)
                }
            }
            
        # Collect Spacing
        for code, inputs in self.spacing_inputs.items():
            if "_check" in code: continue
            if code in ["Fr", "Rs"]:
                 settings["spacing"][code] = {
                    "upp": float(get_text(inputs.get("upp")) or 0),
                    "qual": int(get_text(inputs.get("qual")) or 0)
                }
            else:
                settings["spacing"][code] = {
                    "left": {
                        "upp": float(get_text(inputs["left"].get("upp")) or 0),
                        "qual": int(get_text(inputs["left"].get("qual")) or 0)
                    },
                    "right": {
                        "upp": float(get_text(inputs["right"].get("upp")) or 0),
                        "qual": int(get_text(inputs["right"].get("qual")) or 0)
                    }
                }
                
        self.tolerances_updated.emit(settings)
        return settings

    def accept(self):
        self.apply_settings()
        super().accept()
